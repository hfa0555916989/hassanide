# =============================================================================
# HassanIDE - Universal Binary for macOS
# =============================================================================
# Ÿäÿ®ŸÜŸä ŸÜÿ≥ÿÆÿ© universal binary ŸÑŸÄ macOS (Intel + Apple Silicon ŸÅŸä ŸÖŸÑŸÅ Ÿàÿßÿ≠ÿØ)
# =============================================================================

name: "üçé macOS Universal Binary"

on:
  release:
    types: [published]
  
  workflow_dispatch:
    inputs:
      version:
        description: 'ÿßŸÑÿ•ÿµÿØÿßÿ±'
        required: false
        default: 'latest'

env:
  NODE_OPTIONS: '--max_old_space_size=8192'
  PRODUCT_NAME: 'HassanIDE'

jobs:
  # ===========================================================================
  # ÿ®ŸÜÿßÿ° Universal Binary
  # ===========================================================================
  build-universal:
    name: "üçé Universal Binary"
    runs-on: macos-14
    timeout-minutes: 90
    
    steps:
      # =========================================================================
      # ÿ•ÿπÿØÿßÿØ ÿßŸÑÿ®Ÿäÿ¶ÿ©
      # =========================================================================
      - name: "üì• Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "üì¶ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: "üîß Setup Build Environment"
        run: |
          echo "=== System Info ==="
          uname -a
          sw_vers
          xcodebuild -version || true
          
          # ÿ™ÿ´ÿ®Ÿäÿ™ ÿ£ÿØŸàÿßÿ™ ÿßŸÑÿ®ŸÜÿßÿ°
          brew install jq || true

      # =========================================================================
      # ÿ™ÿ´ÿ®Ÿäÿ™ Dependencies
      # =========================================================================
      - name: "üì¶ Install Dependencies"
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 25
          max_attempts: 3
          command: |
            npm ci --legacy-peer-deps --ignore-scripts || npm install --legacy-peer-deps --ignore-scripts
            npm rebuild

      - name: "üîß Install Global Tools"
        run: |
          corepack enable
          npm install -g typescript ts-node gulp-cli

      # =========================================================================
      # ÿ®ŸÜÿßÿ° x64 (Intel)
      # =========================================================================
      - name: "üî® Build x64 (Intel)"
        run: |
          echo "üî® Building for x64 (Intel)..."
          npm run gulp -- vscode-darwin-x64-min
        continue-on-error: true

      - name: "üì¶ Package x64"
        run: |
          if [ -d "../VSCode-darwin-x64" ]; then
            echo "‚úÖ x64 build found"
            mkdir -p universal-build/x64
            cp -R ../VSCode-darwin-x64 universal-build/x64/
          else
            echo "‚ö†Ô∏è x64 build not found"
          fi

      # =========================================================================
      # ÿ®ŸÜÿßÿ° arm64 (Apple Silicon)
      # =========================================================================
      - name: "üî® Build arm64 (Apple Silicon)"
        run: |
          echo "üî® Building for arm64 (Apple Silicon)..."
          npm run gulp -- vscode-darwin-arm64-min
        continue-on-error: true

      - name: "üì¶ Package arm64"
        run: |
          if [ -d "../VSCode-darwin-arm64" ]; then
            echo "‚úÖ arm64 build found"
            mkdir -p universal-build/arm64
            cp -R ../VSCode-darwin-arm64 universal-build/arm64/
          else
            echo "‚ö†Ô∏è arm64 build not found"
          fi

      # =========================================================================
      # ÿ•ŸÜÿ¥ÿßÿ° Universal Binary
      # =========================================================================
      - name: "üîó Create Universal Binary"
        run: |
          echo "=============================================="
          echo "       üçé Creating Universal Binary"
          echo "=============================================="
          
          # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ Ÿàÿ¨ŸàÿØ ŸÉŸÑÿß ÿßŸÑÿ®ŸÜÿßÿ°ŸäŸÜ
          X64_APP=""
          ARM64_APP=""
          
          if [ -d "universal-build/x64" ]; then
            X64_APP=$(find universal-build/x64 -name "*.app" -type d | head -1)
          fi
          
          if [ -d "universal-build/arm64" ]; then
            ARM64_APP=$(find universal-build/arm64 -name "*.app" -type d | head -1)
          fi
          
          if [ -z "$X64_APP" ] || [ -z "$ARM64_APP" ]; then
            echo "‚ö†Ô∏è Need both x64 and arm64 builds for universal binary"
            echo "Creating individual builds only..."
            exit 0
          fi
          
          echo "üìç x64 App: $X64_APP"
          echo "üìç arm64 App: $ARM64_APP"
          
          # ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿ¨ŸÑÿØ Universal
          mkdir -p universal-build/universal
          
          # ŸÜÿ≥ÿÆ ŸáŸäŸÉŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ŸÖŸÜ arm64 (ÿ£Ÿà x64)
          cp -R "$ARM64_APP" "universal-build/universal/HassanIDE.app"
          
          UNIVERSAL_APP="universal-build/universal/HassanIDE.app"
          
          # ÿØŸÖÿ¨ ÿßŸÑŸÖŸÑŸÅÿßÿ™ ÿßŸÑÿ™ŸÜŸÅŸäÿ∞Ÿäÿ© ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ lipo
          echo "üîó Merging binaries with lipo..."
          
          find "$X64_APP" -type f -perm +111 | while read x64_binary; do
            # ÿßŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿßŸÑŸÖÿ≥ÿßÿ± ÿßŸÑŸÜÿ≥ÿ®Ÿä
            relative_path="${x64_binary#$X64_APP}"
            arm64_binary="$ARM64_APP$relative_path"
            universal_binary="$UNIVERSAL_APP$relative_path"
            
            # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ£ŸÜ ÿßŸÑŸÖŸÑŸÅ ŸáŸà Mach-O binary
            if file "$x64_binary" | grep -q "Mach-O"; then
              if [ -f "$arm64_binary" ] && file "$arm64_binary" | grep -q "Mach-O"; then
                echo "  üîó Merging: $relative_path"
                
                # ÿ•ŸÜÿ¥ÿßÿ° ÿßŸÑŸÖÿ¨ŸÑÿØ ÿ•ÿ∞ÿß ŸÑŸÖ ŸäŸÉŸÜ ŸÖŸàÿ¨ŸàÿØÿßŸã
                mkdir -p "$(dirname "$universal_binary")"
                
                # ÿØŸÖÿ¨ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ lipo
                lipo -create "$x64_binary" "$arm64_binary" -output "$universal_binary" 2>/dev/null || \
                  cp "$arm64_binary" "$universal_binary"
              fi
            fi
          done
          
          echo "‚úÖ Universal binary created!"
          
          # ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßŸÑŸÜÿ™Ÿäÿ¨ÿ©
          MAIN_BINARY=$(find "$UNIVERSAL_APP/Contents/MacOS" -type f | head -1)
          if [ -n "$MAIN_BINARY" ]; then
            echo "üìä Binary architectures:"
            lipo -info "$MAIN_BINARY" || file "$MAIN_BINARY"
          fi

      - name: "üìã Verify Universal Binary"
        run: |
          UNIVERSAL_APP="universal-build/universal/HassanIDE.app"
          
          if [ -d "$UNIVERSAL_APP" ]; then
            echo "=== Universal App Structure ==="
            ls -la "$UNIVERSAL_APP/Contents/"
            
            echo ""
            echo "=== Binary Info ==="
            MAIN_BINARY=$(find "$UNIVERSAL_APP/Contents/MacOS" -type f -name "*" | head -1)
            if [ -n "$MAIN_BINARY" ]; then
              file "$MAIN_BINARY"
              lipo -archs "$MAIN_BINARY" 2>/dev/null || echo "Single arch"
            fi
          else
            echo "‚ö†Ô∏è Universal app not found"
          fi

      # =========================================================================
      # ÿ•ŸÜÿ¥ÿßÿ° DMG
      # =========================================================================
      - name: "üíø Create Universal DMG"
        run: |
          UNIVERSAL_APP="universal-build/universal/HassanIDE.app"
          
          if [ ! -d "$UNIVERSAL_APP" ]; then
            echo "‚ö†Ô∏è No universal app to package"
            exit 0
          fi
          
          VERSION=${{ github.event.release.tag_name || github.event.inputs.version || 'dev' }}
          VERSION="${VERSION#v}"
          
          DMG_NAME="HassanIDE-darwin-universal-${VERSION}.dmg"
          
          echo "üíø Creating DMG: $DMG_NAME"
          
          # ÿ•ŸÜÿ¥ÿßÿ° DMG ÿ®ÿ≥Ÿäÿ∑
          mkdir -p dmg-content
          cp -R "$UNIVERSAL_APP" dmg-content/
          ln -s /Applications dmg-content/Applications
          
          hdiutil create -volname "HassanIDE" \
            -srcfolder dmg-content \
            -ov -format UDZO \
            "$DMG_NAME"
          
          echo "‚úÖ DMG created: $DMG_NAME"
          ls -lh "$DMG_NAME"

      - name: "üì¶ Create Universal ZIP"
        run: |
          UNIVERSAL_APP="universal-build/universal/HassanIDE.app"
          
          if [ ! -d "$UNIVERSAL_APP" ]; then
            echo "‚ö†Ô∏è No universal app to package"
            exit 0
          fi
          
          VERSION=${{ github.event.release.tag_name || github.event.inputs.version || 'dev' }}
          VERSION="${VERSION#v}"
          
          ZIP_NAME="HassanIDE-darwin-universal-${VERSION}.zip"
          
          echo "üì¶ Creating ZIP: $ZIP_NAME"
          
          cd universal-build/universal
          zip -r -y "../../$ZIP_NAME" "HassanIDE.app"
          cd ../..
          
          echo "‚úÖ ZIP created: $ZIP_NAME"
          ls -lh "$ZIP_NAME"

      # =========================================================================
      # ÿ±ŸÅÿπ Artifacts
      # =========================================================================
      - name: "üì§ Upload Universal DMG"
        uses: actions/upload-artifact@v4
        with:
          name: HassanIDE-darwin-universal-dmg
          path: "*.dmg"
          retention-days: 30
          if-no-files-found: ignore

      - name: "üì§ Upload Universal ZIP"
        uses: actions/upload-artifact@v4
        with:
          name: HassanIDE-darwin-universal-zip
          path: "*.zip"
          retention-days: 30
          if-no-files-found: ignore

      # =========================================================================
      # ÿ±ŸÅÿπ ÿ•ŸÑŸâ Release
      # =========================================================================
      - name: "üöÄ Upload to Release"
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            *.dmg
            *.zip
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # ÿ™ŸÇÿ±Ÿäÿ± ÿßŸÑÿ®ŸÜÿßÿ°
  # ===========================================================================
  report:
    name: "üìä Build Report"
    runs-on: ubuntu-latest
    needs: build-universal
    if: always()
    
    steps:
      - name: "üìä Universal Build Report"
        run: |
          echo "=============================================="
          echo "       üçé macOS Universal Binary Report"
          echo "=============================================="
          echo ""
          echo "Build Status: ${{ needs.build-universal.result }}"
          echo ""
          echo "The universal binary combines:"
          echo "  ‚Ä¢ x64 (Intel Macs)"
          echo "  ‚Ä¢ arm64 (Apple Silicon M1/M2/M3)"
          echo ""
          echo "Benefits:"
          echo "  ‚úÖ Single download for all Mac users"
          echo "  ‚úÖ Native performance on both architectures"
          echo "  ‚úÖ Simplified distribution"
          echo ""
          echo "=============================================="
