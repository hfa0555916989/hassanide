# =============================================================================
# HassanIDE - CDN Distribution & Notifications
# =============================================================================
# Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¥Ù„Ù‰ CDN + Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
# ÙŠØ¹Ù…Ù„ Ø¨Ø¹Ø¯ Ø¥Ù†Ø´Ø§Ø¡ Release
# =============================================================================

name: "ğŸŒ CDN & Notifications"

on:
  release:
    types: [published]
  
  workflow_dispatch:
    inputs:
      version:
        description: 'Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù„Ù„ØªÙˆØ²ÙŠØ¹'
        required: true
      notify_only:
        description: 'Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø±ÙØ¹ CDN)'
        type: boolean
        default: false

env:
  PRODUCT_NAME: 'HassanIDE'

jobs:
  # ===========================================================================
  # Ø±ÙØ¹ Ø¥Ù„Ù‰ Cloudflare R2
  # ===========================================================================
  upload-cloudflare-r2:
    name: "â˜ï¸ Cloudflare R2"
    runs-on: ubuntu-latest
    if: github.event.inputs.notify_only != 'true'
    
    steps:
      - name: "ğŸ“¥ Download Release Assets"
        uses: robinraju/release-downloader@v1
        with:
          latest: true
          fileName: "*"
          out-file-path: "downloads"
        continue-on-error: true

      - name: "ğŸ“‹ List downloaded files"
        run: |
          echo "=== Downloaded Files ==="
          ls -la downloads/ 2>/dev/null || echo "No files downloaded"

      - name: "â˜ï¸ Upload to Cloudflare R2"
        if: env.CLOUDFLARE_R2_ACCESS_KEY != ''
        run: |
          # ØªØ«Ø¨ÙŠØª AWS CLI (Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ R2)
          pip install awscli
          
          # Ø¥Ø¹Ø¯Ø§Ø¯ credentials
          aws configure set aws_access_key_id ${{ secrets.CLOUDFLARE_R2_ACCESS_KEY }}
          aws configure set aws_secret_access_key ${{ secrets.CLOUDFLARE_R2_SECRET_KEY }}
          
          # Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
          VERSION="${{ github.event.release.tag_name || github.event.inputs.version }}"
          
          for file in downloads/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              aws s3 cp "$file" "s3://${{ secrets.CLOUDFLARE_R2_BUCKET }}/releases/$VERSION/$filename" \
                --endpoint-url "https://${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.r2.cloudflarestorage.com" \
                || echo "Failed to upload $filename"
            fi
          done
          
          echo "âœ… Files uploaded to Cloudflare R2"
        continue-on-error: true
        env:
          CLOUDFLARE_R2_ACCESS_KEY: ${{ secrets.CLOUDFLARE_R2_ACCESS_KEY }}

  # ===========================================================================
  # Ø±ÙØ¹ Ø¥Ù„Ù‰ AWS S3 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  # ===========================================================================
  upload-aws-s3:
    name: "ğŸ“¦ AWS S3"
    runs-on: ubuntu-latest
    if: github.event.inputs.notify_only != 'true'
    
    steps:
      - name: "ğŸ“¥ Download Release Assets"
        uses: robinraju/release-downloader@v1
        with:
          latest: true
          fileName: "*"
          out-file-path: "downloads"
        continue-on-error: true

      - name: "ğŸ“¦ Upload to AWS S3"
        if: env.AWS_ACCESS_KEY_ID != ''
        uses: jakejarvis/s3-sync-action@master
        with:
          args: --acl public-read --follow-symlinks
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'us-east-1'
          SOURCE_DIR: 'downloads'
          DEST_DIR: 'releases/${{ github.event.release.tag_name || github.event.inputs.version }}'
        continue-on-error: true

  # ===========================================================================
  # Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Discord
  # ===========================================================================
  notify-discord:
    name: "ğŸ’¬ Discord"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ’¬ Send Discord Notification"
        if: secrets.DISCORD_WEBHOOK != ''
        run: |
          VERSION="${{ github.event.release.tag_name || github.event.inputs.version }}"
          RELEASE_URL="${{ github.event.release.html_url || format('https://github.com/{0}/releases/tag/{1}', github.repository, github.event.inputs.version) }}"
          
          curl -H "Content-Type: application/json" \
            -d "{
              \"content\": \"ğŸš€ **HassanIDE $VERSION Released!**\",
              \"embeds\": [{
                \"title\": \"HassanIDE $VERSION\",
                \"description\": \"Ù…Ø­Ø±Ø± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¹Ø±Ø¨ÙŠ - Ø¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†!\",
                \"url\": \"$RELEASE_URL\",
                \"color\": 5814783,
                \"fields\": [
                  {\"name\": \"ğŸªŸ Windows\", \"value\": \"[Download](https://hassanide.com/download/windows)\", \"inline\": true},
                  {\"name\": \"ğŸ macOS\", \"value\": \"[Download](https://hassanide.com/download/macos)\", \"inline\": true},
                  {\"name\": \"ğŸ§ Linux\", \"value\": \"[Download](https://hassanide.com/download/linux)\", \"inline\": true}
                ],
                \"footer\": {\"text\": \"HassanIDE - Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©\"},
                \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
              }]
            }" \
            ${{ secrets.DISCORD_WEBHOOK }} || echo "Discord notification failed"
        continue-on-error: true

  # ===========================================================================
  # Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Telegram
  # ===========================================================================
  notify-telegram:
    name: "ğŸ“± Telegram"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“± Send Telegram Notification"
        if: secrets.TELEGRAM_BOT_TOKEN != '' && secrets.TELEGRAM_CHAT_ID != ''
        run: |
          VERSION="${{ github.event.release.tag_name || github.event.inputs.version }}"
          RELEASE_URL="${{ github.event.release.html_url || format('https://github.com/{0}/releases/tag/{1}', github.repository, github.event.inputs.version) }}"
          
          MESSAGE="ğŸš€ *HassanIDE $VERSION Released\!*

Ù…Ø­Ø±Ø± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¹Ø±Ø¨ÙŠ \- Ø¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†\!

ğŸªŸ [Windows](https://hassanide.com/download/windows)
ğŸ [macOS](https://hassanide.com/download/macos)
ğŸ§ [Linux](https://hassanide.com/download/linux)

ğŸ“¥ [ØªØ­Ù…ÙŠÙ„ Ù…Ù† GitHub]($RELEASE_URL)"
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d text="$MESSAGE" \
            -d parse_mode="MarkdownV2" || echo "Telegram notification failed"
        continue-on-error: true

  # ===========================================================================
  # Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Slack
  # ===========================================================================
  notify-slack:
    name: "ğŸ’¼ Slack"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ’¼ Send Slack Notification"
        if: secrets.SLACK_WEBHOOK != ''
        run: |
          VERSION="${{ github.event.release.tag_name || github.event.inputs.version }}"
          RELEASE_URL="${{ github.event.release.html_url || format('https://github.com/{0}/releases/tag/{1}', github.repository, github.event.inputs.version) }}"
          
          curl -X POST -H 'Content-type: application/json' \
            --data "{
              \"blocks\": [
                {
                  \"type\": \"header\",
                  \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸš€ HassanIDE $VERSION Released!\"}
                },
                {
                  \"type\": \"section\",
                  \"text\": {\"type\": \"mrkdwn\", \"text\": \"Ù…Ø­Ø±Ø± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¹Ø±Ø¨ÙŠ - Ø¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†!\"}
                },
                {
                  \"type\": \"actions\",
                  \"elements\": [
                    {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸªŸ Windows\"}, \"url\": \"https://hassanide.com/download/windows\"},
                    {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸ macOS\"}, \"url\": \"https://hassanide.com/download/macos\"},
                    {\"type\": \"button\", \"text\": {\"type\": \"plain_text\", \"text\": \"ğŸ§ Linux\"}, \"url\": \"https://hassanide.com/download/linux\"}
                  ]
                }
              ]
            }" \
            ${{ secrets.SLACK_WEBHOOK }} || echo "Slack notification failed"
        continue-on-error: true

  # ===========================================================================
  # Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
  # ===========================================================================
  notify-email:
    name: "ğŸ“§ Email"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸ“§ Send Email Notification"
        if: secrets.SMTP_SERVER != ''
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT || 587 }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "ğŸš€ HassanIDE ${{ github.event.release.tag_name || github.event.inputs.version }} Released!"
          to: ${{ secrets.NOTIFICATION_EMAILS }}
          from: "HassanIDE <noreply@hassanide.com>"
          html_body: |
            <h1>ğŸš€ HassanIDE ${{ github.event.release.tag_name || github.event.inputs.version }}</h1>
            <p>Ù…Ø­Ø±Ø± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¹Ø±Ø¨ÙŠ - Ø¥ØµØ¯Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†!</p>
            <h2>ğŸ“¥ Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ­Ù…ÙŠÙ„:</h2>
            <ul>
              <li><a href="https://hassanide.com/download/windows">ğŸªŸ Windows</a></li>
              <li><a href="https://hassanide.com/download/macos">ğŸ macOS</a></li>
              <li><a href="https://hassanide.com/download/linux">ğŸ§ Linux</a></li>
            </ul>
            <p><a href="${{ github.event.release.html_url }}">ğŸ“‹ Release Notes</a></p>
        continue-on-error: true

  # ===========================================================================
  # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹
  # ===========================================================================
  update-website:
    name: "ğŸŒ Update Website"
    runs-on: ubuntu-latest
    
    steps:
      - name: "ğŸŒ Update Download Links"
        if: secrets.WEBSITE_API_URL != ''
        run: |
          VERSION="${{ github.event.release.tag_name || github.event.inputs.version }}"
          
          curl -X POST "${{ secrets.WEBSITE_API_URL }}/api/update-version" \
            -H "Authorization: Bearer ${{ secrets.WEBSITE_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"version\": \"$VERSION\",
              \"release_date\": \"$(date -u +%Y-%m-%d)\",
              \"download_urls\": {
                \"windows_x64\": \"https://github.com/${{ github.repository }}/releases/download/$VERSION/HassanIDE-win32-x64-$VERSION.zip\",
                \"windows_arm64\": \"https://github.com/${{ github.repository }}/releases/download/$VERSION/HassanIDE-win32-arm64-$VERSION.zip\",
                \"macos_x64\": \"https://github.com/${{ github.repository }}/releases/download/$VERSION/HassanIDE-darwin-x64-$VERSION.zip\",
                \"macos_arm64\": \"https://github.com/${{ github.repository }}/releases/download/$VERSION/HassanIDE-darwin-arm64-$VERSION.zip\",
                \"linux_x64\": \"https://github.com/${{ github.repository }}/releases/download/$VERSION/HassanIDE-linux-x64-$VERSION.tar.gz\"
              }
            }" || echo "Website update failed"
        continue-on-error: true

  # ===========================================================================
  # ØªØ­Ù„ÙŠÙ„Ø§Øª ÙˆØ¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  # ===========================================================================
  analytics:
    name: "ğŸ“Š Analytics"
    runs-on: ubuntu-latest
    needs: [upload-cloudflare-r2, upload-aws-s3]
    if: always()
    
    steps:
      - name: "ğŸ“Š Record Release Analytics"
        run: |
          VERSION="${{ github.event.release.tag_name || github.event.inputs.version }}"
          
          echo "=============================================="
          echo "       ğŸ“Š Release Analytics"
          echo "=============================================="
          echo ""
          echo "ğŸ“¦ Version: $VERSION"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”— Repository: ${{ github.repository }}"
          echo ""
          echo "Upload Results:"
          echo "â˜ï¸ Cloudflare R2: ${{ needs.upload-cloudflare-r2.result }}"
          echo "ğŸ“¦ AWS S3: ${{ needs.upload-aws-s3.result }}"
          echo ""
          echo "=============================================="

      - name: "ğŸ“ˆ Send to Analytics Service"
        if: secrets.ANALYTICS_ENDPOINT != ''
        run: |
          VERSION="${{ github.event.release.tag_name || github.event.inputs.version }}"
          
          curl -X POST "${{ secrets.ANALYTICS_ENDPOINT }}" \
            -H "Authorization: Bearer ${{ secrets.ANALYTICS_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"event\": \"release_published\",
              \"product\": \"HassanIDE\",
              \"version\": \"$VERSION\",
              \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
              \"repository\": \"${{ github.repository }}\",
              \"cloudflare_status\": \"${{ needs.upload-cloudflare-r2.result }}\",
              \"s3_status\": \"${{ needs.upload-aws-s3.result }}\"
            }" || echo "Analytics failed"
        continue-on-error: true
