# =============================================================================
# HassanIDE - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª (2024-2025 Best Practices)
# =============================================================================
# Ù‡Ø°Ø§ Ø§Ù„Ù€ workflow ÙŠÙ‚ÙˆÙ… Ø¨Ø¨Ù†Ø§Ø¡ HassanIDE Ù„Ø¬Ù…ÙŠØ¹ Ø£Ù†Ø¸Ù…Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ ÙˆØ§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ§Øª:
# - Windows: x64 Ùˆ ARM64 (Installer + Portable)
# - macOS: Intel Ùˆ Apple Silicon (.dmg Ùˆ .app)
# - Linux: x64 Ùˆ ARM64 (.AppImage Ùˆ .deb Ùˆ .rpm)
#
# ÙŠØ¹Ù…Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯:
# 1. Push Ø¥Ù„Ù‰ main branch
# 2. Ø¥Ù†Ø´Ø§Ø¡ tag Ø¨ØµÙŠØºØ© v* (Ù…Ø«Ù„ v1.0.0)
# 3. Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ (workflow_dispatch)
# =============================================================================

name: "ğŸš€ Build HassanIDE - All Platforms"

# =============================================================================
# Ø§Ù„Ù…ÙØ­ÙÙ‘Ø²Ø§Øª (Triggers)
# =============================================================================
on:
  # ÙŠØ¹Ù…Ù„ Ø¹Ù†Ø¯ push Ø¹Ù„Ù‰ main Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ tags
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'

  # ÙŠØ¯Ø¹Ù… Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© GitHub
  workflow_dispatch:
    inputs:
      version:
        description: 'Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± (Ù…Ø«Ù„ 1.2.3)'
        required: false
        default: ''
      build_windows:
        description: 'Ø¨Ù†Ø§Ø¡ Windows'
        type: boolean
        default: true
      build_macos:
        description: 'Ø¨Ù†Ø§Ø¡ macOS'
        type: boolean
        default: true
      build_linux:
        description: 'Ø¨Ù†Ø§Ø¡ Linux'
        type: boolean
        default: true
      create_release:
        description: 'Ø¥Ù†Ø´Ø§Ø¡ Release'
        type: boolean
        default: false

# =============================================================================
# Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
# =============================================================================
env:
  NODE_VERSION: '20'
  ELECTRON_CACHE: ${{ github.workspace }}/.cache/electron
  ELECTRON_BUILDER_CACHE: ${{ github.workspace }}/.cache/electron-builder
  NPM_CONFIG_LEGACY_PEER_DEPS: 'true'
  PRODUCT_NAME: 'HassanIDE'
  # ØªØ¹Ø·ÙŠÙ„ telemetry
  DISABLE_V8_COMPILE_CACHE: '1'

# =============================================================================
# ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„Ù€ workflows Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†Ø©
# =============================================================================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# =============================================================================
# Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (Jobs)
# =============================================================================
jobs:
  # ===========================================================================
  # ğŸ“‹ Job: ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  # ===========================================================================
  prepare:
    name: "ğŸ“‹ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨Ù†Ø§Ø¡"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_release: ${{ steps.check.outputs.is_release }}
      short_sha: ${{ steps.info.outputs.short_sha }}
      build_date: ${{ steps.info.outputs.build_date }}
    
    steps:
      - name: "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ”¢ ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø±"
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(node -p "require('./package.json').version")-dev.$(date +%Y%m%d)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Ø§Ù„Ø¥ØµØ¯Ø§Ø±: $VERSION"

      - name: "ğŸ·ï¸ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø§Ø¡"
        id: check
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]] || [[ "${{ github.event.inputs.create_release }}" == "true" ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
            echo "âœ… Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø³ÙŠÙ†ØªØ¬ Ø¹Ù†Ù‡ Release"
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Ù‡Ø°Ø§ Ø¨Ù†Ø§Ø¡ ØªØ·ÙˆÙŠØ±ÙŠ ÙÙ‚Ø·"
          fi

      - name: "ğŸ“ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡"
        id: info
        run: |
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "build_date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

  # ===========================================================================
  # ğŸªŸ Job: Ø¨Ù†Ø§Ø¡ Windows x64
  # ===========================================================================
  build-windows-x64:
    name: "ğŸªŸ Windows x64"
    runs-on: windows-latest
    needs: prepare
    if: github.event.inputs.build_windows != 'false'
    timeout-minutes: 45
    continue-on-error: true
    
    env:
      VSCODE_ARCH: x64
      
    steps:
      # ØªÙ†Ø¸ÙŠÙ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„
      - name: "ğŸ§¹ Clean workspace"
        run: |
          if (Test-Path node_modules) { Remove-Item -Recurse -Force node_modules }
          if (Test-Path .npm) { Remove-Item -Recurse -Force .npm }
          if (Test-Path .cache) { Remove-Item -Recurse -Force .cache }
        shell: pwsh
        continue-on-error: true

      - name: "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¨Ù†Ø§Ø¡
      - name: "âš™ï¸ Setup build environment"
        run: |
          corepack enable
          npm install -g typescript ts-node @types/node
        continue-on-error: true

      # ØªØ«Ø¨ÙŠØª Ø§Ù„Ù…ØªØ·Ù„Ø¨Ø§Øª Ù…Ø¹ retry
      - name: "ğŸ“¦ Install dependencies with retry"
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 20
          max_attempts: 3
          command: npm install --legacy-peer-deps --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          npm_config_build_from_source: false

      - name: "ğŸ”„ Rebuild native modules"
        run: |
          npm rebuild
          npm run postinstall || true
        continue-on-error: true

      - name: "âš¡ ØªØ­Ù…ÙŠÙ„ Electron"
        run: npm run electron
        continue-on-error: true

      - name: "ğŸ”¨ Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯"
        run: npm run compile
        continue-on-error: true

      - name: "ğŸ“¦ Ø¨Ù†Ø§Ø¡ Ø­Ø²Ù…Ø© Windows x64"
        run: |
          npx gulp vscode-win32-x64-min
          npx gulp vscode-win32-x64-inno-updater
        continue-on-error: true
        env:
          VSCODE_BUILD_WIN32_TUNNELCLI: 1

      - name: "ğŸ’¿ Ø¥Ù†Ø´Ø§Ø¡ System Installer"
        run: npx gulp vscode-win32-x64-system-setup
        continue-on-error: true

      - name: "ğŸ’¿ Ø¥Ù†Ø´Ø§Ø¡ User Installer"
        run: npx gulp vscode-win32-x64-user-setup
        continue-on-error: true

      - name: "ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…Ø­Ù…ÙˆÙ„Ø© (ZIP)"
        run: |
          $buildPath = "..\VSCode-win32-x64"
          if (Test-Path $buildPath) {
            Compress-Archive -Path $buildPath\* -DestinationPath "HassanIDE-win32-x64-${{ needs.prepare.outputs.version }}.zip" -Force
          }
        shell: pwsh
        continue-on-error: true

      - name: "ğŸ“¤ Ø±ÙØ¹ Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-windows-x64
          path: |
            .build/win32-x64/system-setup/*.exe
            .build/win32-x64/user-setup/*.exe
            HassanIDE-win32-x64-*.zip
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # ğŸªŸ Job: Ø¨Ù†Ø§Ø¡ Windows ARM64
  # ===========================================================================
  build-windows-arm64:
    name: "ğŸªŸ Windows ARM64"
    runs-on: windows-latest
    needs: prepare
    if: github.event.inputs.build_windows != 'false'
    timeout-minutes: 45
    continue-on-error: true
    
    env:
      VSCODE_ARCH: arm64
      
    steps:
      - name: "ğŸ§¹ Clean workspace"
        run: |
          if (Test-Path node_modules) { Remove-Item -Recurse -Force node_modules }
          if (Test-Path .npm) { Remove-Item -Recurse -Force .npm }
          if (Test-Path .cache) { Remove-Item -Recurse -Force .cache }
        shell: pwsh
        continue-on-error: true

      - name: "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: "âš™ï¸ Setup build environment"
        run: |
          corepack enable
          npm install -g typescript ts-node @types/node
        continue-on-error: true

      - name: "ğŸ“¦ Install dependencies with retry"
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 20
          max_attempts: 3
          command: npm install --legacy-peer-deps --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          npm_config_build_from_source: false
          npm_config_arch: arm64

      - name: "ğŸ”„ Rebuild native modules"
        run: |
          npm rebuild
          npm run postinstall || true
        continue-on-error: true

      - name: "âš¡ ØªØ­Ù…ÙŠÙ„ Electron ARM64"
        run: npm run electron
        continue-on-error: true
        env:
          npm_config_arch: arm64

      - name: "ğŸ”¨ Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯"
        run: npm run compile
        continue-on-error: true

      - name: "ğŸ“¦ Ø¨Ù†Ø§Ø¡ Ø­Ø²Ù…Ø© Windows ARM64"
        run: |
          npx gulp vscode-win32-arm64-min
          npx gulp vscode-win32-arm64-inno-updater
        continue-on-error: true
        env:
          VSCODE_BUILD_WIN32_TUNNELCLI: 1

      - name: "ğŸ’¿ Ø¥Ù†Ø´Ø§Ø¡ System Installer ARM64"
        run: npx gulp vscode-win32-arm64-system-setup
        continue-on-error: true

      - name: "ğŸ’¿ Ø¥Ù†Ø´Ø§Ø¡ User Installer ARM64"
        run: npx gulp vscode-win32-arm64-user-setup
        continue-on-error: true

      - name: "ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…Ø­Ù…ÙˆÙ„Ø© ARM64"
        run: |
          $buildPath = "..\VSCode-win32-arm64"
          if (Test-Path $buildPath) {
            Compress-Archive -Path $buildPath\* -DestinationPath "HassanIDE-win32-arm64-${{ needs.prepare.outputs.version }}.zip" -Force
          }
        shell: pwsh
        continue-on-error: true

      - name: "ğŸ“¤ Ø±ÙØ¹ Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-windows-arm64
          path: |
            .build/win32-arm64/system-setup/*.exe
            .build/win32-arm64/user-setup/*.exe
            HassanIDE-win32-arm64-*.zip
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # ğŸ Job: Ø¨Ù†Ø§Ø¡ macOS Intel (x64)
  # ===========================================================================
  build-macos-x64:
    name: "ğŸ macOS Intel"
    runs-on: macos-14
    needs: prepare
    if: github.event.inputs.build_macos != 'false'
    timeout-minutes: 45
    continue-on-error: true
    
    env:
      VSCODE_ARCH: x64
      ELECTRON_SKIP_BINARY_DOWNLOAD: 0
      
    steps:
      - name: "ğŸ§¹ Clean workspace"
        run: |
          git clean -ffdx || true
          rm -rf node_modules .npm .cache || true
        continue-on-error: true

      - name: "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: "âš™ï¸ Setup build environment"
        run: |
          corepack enable
          npm install -g typescript ts-node @types/node
        continue-on-error: true

      - name: "ğŸ“¦ Install dependencies with retry"
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 20
          max_attempts: 3
          command: npm install --legacy-peer-deps --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          npm_config_build_from_source: false

      - name: "ğŸ”„ Rebuild native modules"
        run: |
          npm rebuild
          npm run postinstall || true
        continue-on-error: true

      - name: "âš¡ ØªØ­Ù…ÙŠÙ„ Electron"
        run: npm run electron
        continue-on-error: true

      - name: "ğŸ”¨ Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯"
        run: npm run compile
        continue-on-error: true

      - name: "ğŸ“¦ Ø¨Ù†Ø§Ø¡ macOS x64"
        run: npx gulp vscode-darwin-x64-min
        continue-on-error: true

      - name: "ğŸ’¿ Ø¥Ù†Ø´Ø§Ø¡ DMG"
        run: |
          brew install create-dmg || true
          npx gulp vscode-darwin-x64-build-dmg
        continue-on-error: true

      - name: "ğŸ“ Ø¶ØºØ· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"
        run: |
          BUILD_PATH="../VSCode-darwin-x64"
          if [ -d "$BUILD_PATH" ]; then
            cd ..
            zip -r -y "hassanide/HassanIDE-darwin-x64-${{ needs.prepare.outputs.version }}.zip" "VSCode-darwin-x64"
          fi
        continue-on-error: true

      - name: "ğŸ“¤ Ø±ÙØ¹ Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-macos-x64
          path: |
            .build/darwin-x64/*.dmg
            HassanIDE-darwin-x64-*.zip
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # ğŸ Job: Ø¨Ù†Ø§Ø¡ macOS Apple Silicon (ARM64)
  # ===========================================================================
  build-macos-arm64:
    name: "ğŸ macOS Apple Silicon"
    runs-on: macos-14
    needs: prepare
    if: github.event.inputs.build_macos != 'false'
    timeout-minutes: 45
    continue-on-error: true
    
    env:
      VSCODE_ARCH: arm64
      ELECTRON_SKIP_BINARY_DOWNLOAD: 0
      
    steps:
      - name: "ğŸ§¹ Clean workspace"
        run: |
          git clean -ffdx || true
          rm -rf node_modules .npm .cache || true
        continue-on-error: true

      - name: "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: "âš™ï¸ Setup build environment"
        run: |
          corepack enable
          npm install -g typescript ts-node @types/node
        continue-on-error: true

      - name: "ğŸ“¦ Install dependencies with retry"
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 20
          max_attempts: 3
          command: npm install --legacy-peer-deps --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          npm_config_build_from_source: false

      - name: "ğŸ”„ Rebuild native modules"
        run: |
          npm rebuild
          npm run postinstall || true
        continue-on-error: true

      - name: "âš¡ ØªØ­Ù…ÙŠÙ„ Electron ARM64"
        run: npm run electron
        continue-on-error: true

      - name: "ğŸ”¨ Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯"
        run: npm run compile
        continue-on-error: true

      - name: "ğŸ“¦ Ø¨Ù†Ø§Ø¡ macOS ARM64"
        run: npx gulp vscode-darwin-arm64-min
        continue-on-error: true

      - name: "ğŸ’¿ Ø¥Ù†Ø´Ø§Ø¡ DMG"
        run: |
          brew install create-dmg || true
          npx gulp vscode-darwin-arm64-build-dmg
        continue-on-error: true

      - name: "ğŸ“ Ø¶ØºØ· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚"
        run: |
          BUILD_PATH="../VSCode-darwin-arm64"
          if [ -d "$BUILD_PATH" ]; then
            cd ..
            zip -r -y "hassanide/HassanIDE-darwin-arm64-${{ needs.prepare.outputs.version }}.zip" "VSCode-darwin-arm64"
          fi
        continue-on-error: true

      - name: "ğŸ“¤ Ø±ÙØ¹ Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-macos-arm64
          path: |
            .build/darwin-arm64/*.dmg
            HassanIDE-darwin-arm64-*.zip
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # ğŸ§ Job: Ø¨Ù†Ø§Ø¡ Linux x64
  # ===========================================================================
  build-linux-x64:
    name: "ğŸ§ Linux x64"
    runs-on: ubuntu-latest
    needs: prepare
    if: github.event.inputs.build_linux != 'false'
    timeout-minutes: 45
    continue-on-error: true
    
    env:
      VSCODE_ARCH: x64
      
    steps:
      - name: "ğŸ§¹ Clean workspace"
        run: |
          git clean -ffdx || true
          rm -rf node_modules .npm .cache || true
        continue-on-error: true

      - name: "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: "ğŸ”§ Setup Linux dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libx11-dev \
            libxkbfile-dev \
            libsecret-1-dev \
            libkrb5-dev \
            python3 \
            pkg-config \
            fakeroot \
            rpm \
            dpkg \
            libfuse2 \
            zsync

      - name: "ğŸ”§ Fix permissions"
        run: sudo chown -R $USER:$USER .
        continue-on-error: true

      - name: "âš™ï¸ Setup build environment"
        run: |
          corepack enable
          npm install -g typescript ts-node @types/node
        continue-on-error: true

      - name: "ğŸ“¦ Install dependencies with retry"
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 20
          max_attempts: 3
          command: npm install --legacy-peer-deps --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          npm_config_build_from_source: false

      - name: "ğŸ”„ Rebuild native modules"
        run: |
          npm rebuild
          npm run postinstall || true
        continue-on-error: true

      - name: "âš¡ ØªØ­Ù…ÙŠÙ„ Electron"
        run: npm run electron
        continue-on-error: true

      - name: "ğŸ”¨ Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯"
        run: npm run compile
        continue-on-error: true

      - name: "ğŸ“¦ Ø¨Ù†Ø§Ø¡ Linux x64"
        run: npx gulp vscode-linux-x64-min
        continue-on-error: true

      - name: "ğŸ“¦ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø²Ù…Ø© DEB"
        run: |
          npx gulp vscode-linux-x64-prepare-deb
          npx gulp vscode-linux-x64-build-deb
        continue-on-error: true

      - name: "ğŸ“¦ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø²Ù…Ø© RPM"
        run: npx gulp vscode-linux-x64-build-rpm
        continue-on-error: true

      - name: "ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù tar.gz"
        run: |
          BUILD_PATH="../VSCode-linux-x64"
          if [ -d "$BUILD_PATH" ]; then
            tar -czvf "HassanIDE-linux-x64-${{ needs.prepare.outputs.version }}.tar.gz" -C .. "VSCode-linux-x64"
          fi
        continue-on-error: true

      - name: "ğŸ“¦ Ø¥Ù†Ø´Ø§Ø¡ AppImage"
        run: |
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
          chmod +x appimagetool-x86_64.AppImage
          
          BUILD_PATH="../VSCode-linux-x64"
          APPDIR="HassanIDE.AppDir"
          
          if [ -d "$BUILD_PATH" ]; then
            mkdir -p "$APPDIR/usr/bin"
            mkdir -p "$APPDIR/usr/share/applications"
            mkdir -p "$APPDIR/usr/share/icons/hicolor/256x256/apps"
            
            cp -r $BUILD_PATH/* "$APPDIR/usr/bin/"
            
            cat > "$APPDIR/hassanide.desktop" << EOF
          [Desktop Entry]
          Name=Hassan IDE
          Exec=hassanide
          Icon=hassanide
          Type=Application
          Categories=Development;IDE;
          EOF
            
            if [ -f "resources/linux/code.png" ]; then
              cp resources/linux/code.png "$APPDIR/hassanide.png"
            fi
            
            cat > "$APPDIR/AppRun" << 'EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin/:${PATH}"
          exec "${HERE}/usr/bin/hassanide" "$@"
          EOF
            chmod +x "$APPDIR/AppRun"
            
            ARCH=x86_64 ./appimagetool-x86_64.AppImage "$APPDIR" "HassanIDE-linux-x64-${{ needs.prepare.outputs.version }}.AppImage"
          fi
        continue-on-error: true

      - name: "ğŸ“¤ Ø±ÙØ¹ Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-linux-x64
          path: |
            .build/linux/deb/amd64/*.deb
            .build/linux/rpm/x86_64/*.rpm
            HassanIDE-linux-x64-*.tar.gz
            HassanIDE-linux-x64-*.AppImage
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # ğŸ§ Job: Ø¨Ù†Ø§Ø¡ Linux ARM64
  # ===========================================================================
  build-linux-arm64:
    name: "ğŸ§ Linux ARM64"
    runs-on: ubuntu-latest
    needs: prepare
    if: github.event.inputs.build_linux != 'false'
    timeout-minutes: 45
    continue-on-error: true
    
    env:
      VSCODE_ARCH: arm64
      
    steps:
      - name: "ğŸ§¹ Clean workspace"
        run: |
          git clean -ffdx || true
          rm -rf node_modules .npm .cache || true
        continue-on-error: true

      - name: "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: "ğŸ”§ Setup Linux dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libx11-dev \
            libxkbfile-dev \
            libsecret-1-dev \
            libkrb5-dev \
            python3 \
            pkg-config \
            fakeroot \
            rpm \
            dpkg \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            crossbuild-essential-arm64

      - name: "ğŸ”§ Fix permissions"
        run: sudo chown -R $USER:$USER .
        continue-on-error: true

      - name: "âš™ï¸ Setup build environment"
        run: |
          corepack enable
          npm install -g typescript ts-node @types/node
        continue-on-error: true

      - name: "ğŸ“¦ Install dependencies with retry"
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 20
          max_attempts: 3
          command: npm install --legacy-peer-deps --ignore-scripts
        env:
          PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: 1
          ELECTRON_SKIP_BINARY_DOWNLOAD: 1
          npm_config_build_from_source: false
          npm_config_arch: arm64
          CC: aarch64-linux-gnu-gcc
          CXX: aarch64-linux-gnu-g++

      - name: "ğŸ”„ Rebuild native modules"
        run: |
          npm rebuild
          npm run postinstall || true
        continue-on-error: true

      - name: "âš¡ ØªØ­Ù…ÙŠÙ„ Electron ARM64"
        run: npm run electron
        continue-on-error: true
        env:
          npm_config_arch: arm64

      - name: "ğŸ”¨ Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯"
        run: npm run compile
        continue-on-error: true

      - name: "ğŸ“¦ Ø¨Ù†Ø§Ø¡ Linux ARM64"
        run: npx gulp vscode-linux-arm64-min
        continue-on-error: true

      - name: "ğŸ“¦ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø²Ù…Ø© DEB ARM64"
        run: |
          npx gulp vscode-linux-arm64-prepare-deb
          npx gulp vscode-linux-arm64-build-deb
        continue-on-error: true

      - name: "ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù tar.gz"
        run: |
          BUILD_PATH="../VSCode-linux-arm64"
          if [ -d "$BUILD_PATH" ]; then
            tar -czvf "HassanIDE-linux-arm64-${{ needs.prepare.outputs.version }}.tar.gz" -C .. "VSCode-linux-arm64"
          fi
        continue-on-error: true

      - name: "ğŸ“¤ Ø±ÙØ¹ Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-linux-arm64
          path: |
            .build/linux/deb/arm64/*.deb
            HassanIDE-linux-arm64-*.tar.gz
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # ğŸ‰ Job: Ø¥Ù†Ø´Ø§Ø¡ GitHub Release
  # ===========================================================================
  create-release:
    name: "ğŸ‰ Ø¥Ù†Ø´Ø§Ø¡ Release"
    runs-on: ubuntu-latest
    needs: 
      - prepare
      - build-windows-x64
      - build-windows-arm64
      - build-macos-x64
      - build-macos-arm64
      - build-linux-x64
      - build-linux-arm64
    
    if: |
      always() && 
      (startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true') &&
      !contains(needs.*.result, 'cancelled')
    
    permissions:
      contents: write
      
    steps:
      - name: "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯"
        uses: actions/checkout@v4

      - name: "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Windows x64 Artifacts"
        uses: actions/download-artifact@v4
        with:
          name: hassanide-windows-x64
          path: artifacts/windows-x64
        continue-on-error: true

      - name: "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Windows ARM64 Artifacts"
        uses: actions/download-artifact@v4
        with:
          name: hassanide-windows-arm64
          path: artifacts/windows-arm64
        continue-on-error: true

      - name: "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ macOS x64 Artifacts"
        uses: actions/download-artifact@v4
        with:
          name: hassanide-macos-x64
          path: artifacts/macos-x64
        continue-on-error: true

      - name: "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ macOS ARM64 Artifacts"
        uses: actions/download-artifact@v4
        with:
          name: hassanide-macos-arm64
          path: artifacts/macos-arm64
        continue-on-error: true

      - name: "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Linux x64 Artifacts"
        uses: actions/download-artifact@v4
        with:
          name: hassanide-linux-x64
          path: artifacts/linux-x64
        continue-on-error: true

      - name: "ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Linux ARM64 Artifacts"
        uses: actions/download-artifact@v4
        with:
          name: hassanide-linux-arm64
          path: artifacts/linux-arm64
        continue-on-error: true

      - name: "ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª"
        run: |
          echo "=== Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø© ==="
          find artifacts -type f -name "*" 2>/dev/null | head -50 || echo "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª"
          echo ""
          echo "=== Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ==="
          du -sh artifacts/* 2>/dev/null || echo "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª"

      - name: "ğŸ“ ØªØ¬Ù‡ÙŠØ² Ù…Ù„ÙØ§Øª Release"
        id: prepare_files
        run: |
          mkdir -p release_files
          
          find artifacts -type f \( \
            -name "*.exe" -o \
            -name "*.dmg" -o \
            -name "*.deb" -o \
            -name "*.rpm" -o \
            -name "*.AppImage" -o \
            -name "*.tar.gz" -o \
            -name "*.zip" \
          \) -exec cp {} release_files/ \; 2>/dev/null || true
          
          cd release_files
          for file in *; do
            if [ -f "$file" ]; then
              new_name=$(echo "$file" | sed 's/VSCode/HassanIDE/g' | sed 's/Code/HassanIDE/g')
              if [ "$file" != "$new_name" ]; then
                mv "$file" "$new_name" 2>/dev/null || true
              fi
            fi
          done
          
          echo "=== Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø¬Ø§Ù‡Ø²Ø© Ù„Ù„Ù€ Release ==="
          ls -la 2>/dev/null || echo "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª"

      - name: "ğŸ‰ Ø¥Ù†Ø´Ø§Ø¡ GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          name: "ğŸš€ HassanIDE v${{ needs.prepare.outputs.version }}"
          tag_name: v${{ needs.prepare.outputs.version }}
          draft: false
          prerelease: ${{ contains(needs.prepare.outputs.version, 'alpha') || contains(needs.prepare.outputs.version, 'beta') || contains(needs.prepare.outputs.version, 'dev') }}
          generate_release_notes: true
          files: release_files/*
          body: |
            # ğŸš€ HassanIDE v${{ needs.prepare.outputs.version }}
            
            ## Ù…Ø­Ø±Ø± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¹Ø±Ø¨ÙŠ - Ø¨ÙŠØ¦Ø© Ø§Ù„ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©
            
            ---
            
            ## ğŸ“¥ Ø§Ù„ØªØ­Ù…ÙŠÙ„
            
            ### ğŸªŸ Windows
            | Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ© | Ù†ÙˆØ¹ Ø§Ù„ØªØ«Ø¨ÙŠØª |
            |-----------|-------------|
            | x64 (64-bit) | System/User Installer + Portable |
            | ARM64 | System/User Installer + Portable |
            
            ### ğŸ macOS
            | Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ© | Ø§Ù„ÙˆØµÙ |
            |-----------|-------|
            | Intel (x64) | Ù„Ø£Ø¬Ù‡Ø²Ø© Mac Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© |
            | Apple Silicon (M1/M2/M3) | Ù„Ø£Ø¬Ù‡Ø²Ø© Mac Ø§Ù„Ø­Ø¯ÙŠØ«Ø© |
            
            ### ğŸ§ Linux
            | Ø§Ù„Ù…Ø¹Ù…Ø§Ø±ÙŠØ© | Ù†ÙˆØ¹ Ø§Ù„Ø­Ø²Ù…Ø© |
            |-----------|-----------|
            | x64 | DEB, RPM, AppImage, tar.gz |
            | ARM64 | DEB, tar.gz |
            
            ---
            
            ## ğŸ”‘ ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ±Ø®ÙŠØµ
            
            1. Ø§ÙØªØ­ HassanIDE
            2. Ø§Ø¶ØºØ· `Ctrl+Shift+P` (Ø£Ùˆ `Cmd+Shift+P` Ø¹Ù„Ù‰ Mac)
            3. Ø§ÙƒØªØ¨ "Activate License"
            4. Ø£Ø¯Ø®Ù„ Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ±Ø®ÙŠØµ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
            
            ---
            
            **Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¨Ù†Ø§Ø¡:**
            - ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${{ needs.prepare.outputs.build_date }}
            - ğŸ”– Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${{ needs.prepare.outputs.version }}
            - ğŸ”— Commit: ${{ needs.prepare.outputs.short_sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # ğŸ“Š Job: Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†Ø§Ø¡
  # ===========================================================================
  summary:
    name: "ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†Ø§Ø¡"
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build-windows-x64
      - build-windows-arm64
      - build-macos-x64
      - build-macos-arm64
      - build-linux-x64
      - build-linux-arm64
    if: always()
    
    steps:
      - name: "ğŸ“Š Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ù†Ø§Ø¡"
        run: |
          echo "=============================================="
          echo "       ğŸ“Š Ù…Ù„Ø®Øµ Ø¨Ù†Ø§Ø¡ HassanIDE"
          echo "=============================================="
          echo ""
          echo "ğŸ“¦ Ø§Ù„Ø¥ØµØ¯Ø§Ø±: ${{ needs.prepare.outputs.version }}"
          echo "ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: $(date)"
          echo ""
          echo "=============================================="
          echo "       ğŸ“‹ Ø­Ø§Ù„Ø© ÙƒÙ„ Ù…Ù†ØµØ©"
          echo "=============================================="
          echo ""
          echo "ğŸªŸ Windows x64:    ${{ needs.build-windows-x64.result }}"
          echo "ğŸªŸ Windows ARM64:  ${{ needs.build-windows-arm64.result }}"
          echo "ğŸ macOS x64:      ${{ needs.build-macos-x64.result }}"
          echo "ğŸ macOS ARM64:    ${{ needs.build-macos-arm64.result }}"
          echo "ğŸ§ Linux x64:      ${{ needs.build-linux-x64.result }}"
          echo "ğŸ§ Linux ARM64:    ${{ needs.build-linux-arm64.result }}"
          echo ""
          echo "=============================================="
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù†Ø¬Ø§Ø­ Ø§Ù„ÙƒÙ„ÙŠ
          success_count=0
          [[ "${{ needs.build-windows-x64.result }}" == "success" ]] && ((success_count++))
          [[ "${{ needs.build-macos-x64.result }}" == "success" ]] && ((success_count++))
          [[ "${{ needs.build-linux-x64.result }}" == "success" ]] && ((success_count++))
          
          if [ $success_count -gt 0 ]; then
            echo "âœ… ØªÙ… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­ Ù„Ù€ $success_count Ù…Ù†ØµØ©/Ù…Ù†ØµØ§Øª!"
          else
            echo "âš ï¸ Ù„Ù… ÙŠÙ†Ø¬Ø­ Ø£ÙŠ Ø¨Ù†Ø§Ø¡ - ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª"
          fi
