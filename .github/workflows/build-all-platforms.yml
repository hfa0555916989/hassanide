# =============================================================================
# HassanIDE - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØµØ§Øª
# =============================================================================
# Ø§Ù„Ø¥ØµØ¯Ø§Ø±: 2.0.0 (2025)
# ÙŠØ¯Ø¹Ù…: Windows, macOS, Linux (x64 Ùˆ ARM64)
# =============================================================================

name: "ğŸš€ Build HassanIDE - All Platforms"

# =============================================================================
# Ø§Ù„Ù…ÙØ­ÙÙ‘Ø²Ø§Øª (Triggers)
# =============================================================================
on:
  push:
    branches:
      - main
    tags:
      - 'v*'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/ISSUE_TEMPLATE/**'

  pull_request:
    branches:
      - main

  workflow_dispatch:
    inputs:
      version:
        description: 'Ø±Ù‚Ù… Ø§Ù„Ø¥ØµØ¯Ø§Ø± (Ù…Ø«Ù„ 1.2.3)'
        required: false
        default: ''
      skip_windows:
        description: 'ØªØ®Ø·ÙŠ Ø¨Ù†Ø§Ø¡ Windows'
        type: boolean
        default: false
      skip_macos:
        description: 'ØªØ®Ø·ÙŠ Ø¨Ù†Ø§Ø¡ macOS'
        type: boolean
        default: false
      skip_linux:
        description: 'ØªØ®Ø·ÙŠ Ø¨Ù†Ø§Ø¡ Linux'
        type: boolean
        default: false
      create_release:
        description: 'Ø¥Ù†Ø´Ø§Ø¡ Release'
        type: boolean
        default: false

# =============================================================================
# Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
# =============================================================================
env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  NPM_CONFIG_LEGACY_PEER_DEPS: 'true'
  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1'
  ELECTRON_SKIP_BINARY_DOWNLOAD: '1'
  PRODUCT_NAME: 'HassanIDE'

# =============================================================================
# ØªÙ‚ÙŠÙŠØ¯ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ØªØ²Ø§Ù…Ù†
# =============================================================================
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# =============================================================================
# Ø§Ù„ÙˆØ¸Ø§Ø¦Ù (Jobs)
# =============================================================================
jobs:
  # ===========================================================================
  # ğŸ“‹ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨Ù†Ø§Ø¡
  # ===========================================================================
  prepare:
    name: "ğŸ“‹ Prepare Build"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      short_sha: ${{ steps.info.outputs.short_sha }}
      build_date: ${{ steps.info.outputs.build_date }}

    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ”¢ Determine version"
        id: version
        run: |
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(node -p "require('./package.json').version")-dev.$(date +%Y%m%d%H%M)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"

      - name: "ğŸ“ Build info"
        id: info
        run: |
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "build_date=$(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

  # ===========================================================================
  # ğŸªŸ Ø¨Ù†Ø§Ø¡ Windows
  # ===========================================================================
  build-windows:
    name: "ğŸªŸ Windows ${{ matrix.arch }}"
    runs-on: windows-latest
    needs: prepare
    if: github.event.inputs.skip_windows != 'true'
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]

    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "ğŸ“¦ Install global dependencies"
        run: |
          npm install -g typescript ts-node node-gyp
          npm install -g @vscode/vsce

      - name: "ğŸ§¹ Clean workspace"
        run: |
          if (Test-Path node_modules) { Remove-Item -Recurse -Force node_modules }
          if (Test-Path .build) { Remove-Item -Recurse -Force .build }
          npm cache clean --force
        shell: pwsh

      - name: "ğŸ“¦ Install dependencies"
        run: |
          npm install --legacy-peer-deps --ignore-scripts
          npm run postinstall || echo "Postinstall completed with warnings"
        env:
          npm_config_arch: ${{ matrix.arch }}
          CHILD_CONCURRENCY: 1

      - name: "âš¡ Download Electron"
        run: npm run electron
        env:
          npm_config_arch: ${{ matrix.arch }}
          ELECTRON_SKIP_BINARY_DOWNLOAD: 0

      - name: "ğŸ”¨ Compile TypeScript"
        run: npm run compile

      - name: "ğŸ“¦ Build VSCode Win32 ${{ matrix.arch }}"
        run: |
          npx gulp vscode-win32-${{ matrix.arch }}-min
        env:
          VSCODE_ARCH: ${{ matrix.arch }}

      - name: "ğŸ”§ Build Inno Updater"
        run: |
          npx gulp vscode-win32-${{ matrix.arch }}-inno-updater
        continue-on-error: true
        env:
          VSCODE_ARCH: ${{ matrix.arch }}

      - name: "ğŸ’¿ Create System Setup"
        run: |
          npx gulp vscode-win32-${{ matrix.arch }}-system-setup
        continue-on-error: true

      - name: "ğŸ’¿ Create User Setup"
        run: |
          npx gulp vscode-win32-${{ matrix.arch }}-user-setup
        continue-on-error: true

      - name: "ğŸ“ Create Portable ZIP"
        run: |
          $buildPath = "..\VSCode-win32-${{ matrix.arch }}"
          if (Test-Path $buildPath) {
            $version = "${{ needs.prepare.outputs.version }}"
            Compress-Archive -Path "$buildPath\*" -DestinationPath "HassanIDE-win32-${{ matrix.arch }}-$version.zip" -Force
            echo "âœ… Created portable ZIP"
          } else {
            echo "âš ï¸ Build path not found: $buildPath"
            Get-ChildItem -Path ".." -Directory | ForEach-Object { echo $_.FullName }
          }
        shell: pwsh

      - name: "ğŸ“‹ List build outputs"
        run: |
          echo "=== .build directory ==="
          if (Test-Path .build) { Get-ChildItem -Recurse .build -Depth 3 } else { echo "No .build directory" }
          echo ""
          echo "=== Parent directory ==="
          Get-ChildItem -Path ".." -Directory
          echo ""
          echo "=== Current directory ZIPs ==="
          Get-ChildItem -Filter "*.zip"
          echo ""
          echo "=== EXE files ==="
          Get-ChildItem -Recurse -Filter "*.exe" -ErrorAction SilentlyContinue | Select-Object -First 20
        shell: pwsh

      - name: "ğŸ“¤ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-windows-${{ matrix.arch }}
          path: |
            .build/win32-${{ matrix.arch }}/system-setup/*.exe
            .build/win32-${{ matrix.arch }}/user-setup/*.exe
            .build/win32-${{ matrix.arch }}/archive/*.zip
            HassanIDE-win32-${{ matrix.arch }}-*.zip
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # ğŸ Ø¨Ù†Ø§Ø¡ macOS
  # ===========================================================================
  build-macos:
    name: "ğŸ macOS ${{ matrix.arch }}"
    runs-on: ${{ matrix.runner }}
    needs: prepare
    if: github.event.inputs.skip_macos != 'true'
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: x64
            runner: macos-13
            electron_arch: x64
          - arch: arm64
            runner: macos-14
            electron_arch: arm64

    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "ğŸ“¦ Install global dependencies"
        run: |
          npm install -g typescript ts-node node-gyp
          brew install create-dmg || true

      - name: "ğŸ§¹ Clean workspace"
        run: |
          rm -rf node_modules .build || true
          npm cache clean --force

      - name: "ğŸ“¦ Install dependencies"
        run: |
          npm install --legacy-peer-deps --ignore-scripts
          npm run postinstall || echo "Postinstall completed with warnings"
        env:
          npm_config_arch: ${{ matrix.arch }}

      - name: "âš¡ Download Electron"
        run: npm run electron
        env:
          npm_config_arch: ${{ matrix.arch }}
          ELECTRON_SKIP_BINARY_DOWNLOAD: 0

      - name: "ğŸ”¨ Compile TypeScript"
        run: npm run compile

      - name: "ğŸ“¦ Build VSCode Darwin ${{ matrix.arch }}"
        run: |
          npx gulp vscode-darwin-${{ matrix.arch }}-min
        env:
          VSCODE_ARCH: ${{ matrix.arch }}

      - name: "ğŸ’¿ Create DMG"
        run: |
          npx gulp vscode-darwin-${{ matrix.arch }}-build-dmg || echo "DMG creation skipped"
        continue-on-error: true

      - name: "ğŸ“ Create ZIP Archive"
        run: |
          BUILD_PATH="../VSCode-darwin-${{ matrix.arch }}"
          VERSION="${{ needs.prepare.outputs.version }}"
          
          if [ -d "$BUILD_PATH" ]; then
            cd ..
            zip -r -y "hassanide/HassanIDE-darwin-${{ matrix.arch }}-$VERSION.zip" "VSCode-darwin-${{ matrix.arch }}"
            echo "âœ… Created ZIP archive"
          else
            echo "âš ï¸ Build path not found: $BUILD_PATH"
            ls -la ..
          fi

      - name: "ğŸ“‹ List build outputs"
        run: |
          echo "=== .build directory ==="
          ls -la .build/ 2>/dev/null || echo "No .build directory"
          echo ""
          echo "=== Parent directory ==="
          ls -la ../
          echo ""
          echo "=== DMG files ==="
          find . -name "*.dmg" 2>/dev/null || echo "No DMG files"
          echo ""
          echo "=== ZIP files ==="
          find . -name "*.zip" 2>/dev/null || echo "No ZIP files"

      - name: "ğŸ“¤ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-macos-${{ matrix.arch }}
          path: |
            .build/darwin-${{ matrix.arch }}/*.dmg
            .build/darwin/*.dmg
            HassanIDE-darwin-${{ matrix.arch }}-*.zip
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # ğŸ§ Ø¨Ù†Ø§Ø¡ Linux
  # ===========================================================================
  build-linux:
    name: "ğŸ§ Linux ${{ matrix.arch }}"
    runs-on: ubuntu-22.04
    needs: prepare
    if: github.event.inputs.skip_linux != 'true'
    timeout-minutes: 60

    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]

    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "ğŸ”§ Install system dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            g++ \
            libx11-dev \
            libxkbfile-dev \
            libsecret-1-dev \
            libkrb5-dev \
            libgtk-3-dev \
            libnss3-dev \
            libgdk-pixbuf2.0-dev \
            libatk-bridge2.0-dev \
            libatspi2.0-dev \
            libdrm-dev \
            libgbm-dev \
            fakeroot \
            rpm \
            dpkg \
            dpkg-dev \
            libfuse2 \
            zsync \
            pkg-config

      - name: "ğŸ”§ Install ARM64 cross-compilation tools"
        if: matrix.arch == 'arm64'
        run: |
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            g++-aarch64-linux-gnu \
            crossbuild-essential-arm64

      - name: "ğŸ“¦ Install global dependencies"
        run: |
          npm install -g typescript ts-node node-gyp

      - name: "ğŸ§¹ Clean workspace"
        run: |
          rm -rf node_modules .build || true
          npm cache clean --force

      - name: "ğŸ“¦ Install dependencies"
        run: |
          npm install --legacy-peer-deps --ignore-scripts
          npm run postinstall || echo "Postinstall completed with warnings"
        env:
          npm_config_arch: ${{ matrix.arch }}
          CC: ${{ matrix.arch == 'arm64' && 'aarch64-linux-gnu-gcc' || 'gcc' }}
          CXX: ${{ matrix.arch == 'arm64' && 'aarch64-linux-gnu-g++' || 'g++' }}

      - name: "âš¡ Download Electron"
        run: npm run electron
        env:
          npm_config_arch: ${{ matrix.arch }}
          ELECTRON_SKIP_BINARY_DOWNLOAD: 0

      - name: "ğŸ”¨ Compile TypeScript"
        run: npm run compile

      - name: "ğŸ“¦ Build VSCode Linux ${{ matrix.arch }}"
        run: |
          npx gulp vscode-linux-${{ matrix.arch }}-min
        env:
          VSCODE_ARCH: ${{ matrix.arch }}

      - name: "ğŸ“¦ Create DEB package"
        run: |
          npx gulp vscode-linux-${{ matrix.arch }}-prepare-deb || true
          npx gulp vscode-linux-${{ matrix.arch }}-build-deb || echo "DEB creation skipped"
        continue-on-error: true

      - name: "ğŸ“¦ Create RPM package"
        run: |
          npx gulp vscode-linux-${{ matrix.arch }}-build-rpm || echo "RPM creation skipped"
        continue-on-error: true

      - name: "ğŸ“ Create tar.gz Archive"
        run: |
          BUILD_PATH="../VSCode-linux-${{ matrix.arch }}"
          VERSION="${{ needs.prepare.outputs.version }}"
          
          if [ -d "$BUILD_PATH" ]; then
            tar -czvf "HassanIDE-linux-${{ matrix.arch }}-$VERSION.tar.gz" -C .. "VSCode-linux-${{ matrix.arch }}"
            echo "âœ… Created tar.gz archive"
          else
            echo "âš ï¸ Build path not found: $BUILD_PATH"
            ls -la ..
          fi

      - name: "ğŸ“¦ Create AppImage"
        if: matrix.arch == 'x64'
        run: |
          # Download appimagetool
          wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
          chmod +x appimagetool
          
          BUILD_PATH="../VSCode-linux-${{ matrix.arch }}"
          VERSION="${{ needs.prepare.outputs.version }}"
          
          if [ -d "$BUILD_PATH" ]; then
            # Create AppDir structure
            APPDIR="HassanIDE.AppDir"
            mkdir -p "$APPDIR/usr/bin"
            mkdir -p "$APPDIR/usr/share/applications"
            mkdir -p "$APPDIR/usr/share/icons/hicolor/256x256/apps"
            
            # Copy files
            cp -r $BUILD_PATH/* "$APPDIR/usr/bin/"
            
            # Create desktop entry
            echo "[Desktop Entry]" > "$APPDIR/hassanide.desktop"
            echo "Name=HassanIDE" >> "$APPDIR/hassanide.desktop"
            echo "Comment=Code Editor" >> "$APPDIR/hassanide.desktop"
            echo "Exec=hassanide %F" >> "$APPDIR/hassanide.desktop"
            echo "Icon=hassanide" >> "$APPDIR/hassanide.desktop"
            echo "Type=Application" >> "$APPDIR/hassanide.desktop"
            echo "Categories=Development;IDE;TextEditor;" >> "$APPDIR/hassanide.desktop"
            echo "StartupNotify=true" >> "$APPDIR/hassanide.desktop"
            echo "StartupWMClass=HassanIDE" >> "$APPDIR/hassanide.desktop"
            echo "MimeType=text/plain;" >> "$APPDIR/hassanide.desktop"
            
            # Copy icon
            if [ -f "resources/linux/code.png" ]; then
              cp resources/linux/code.png "$APPDIR/hassanide.png"
              cp resources/linux/code.png "$APPDIR/usr/share/icons/hicolor/256x256/apps/hassanide.png"
            fi
            
            # Link desktop file
            cp "$APPDIR/hassanide.desktop" "$APPDIR/usr/share/applications/"
            
            # Create AppRun
            echo '#!/bin/bash' > "$APPDIR/AppRun"
            echo 'SELF=$(readlink -f "$0")' >> "$APPDIR/AppRun"
            echo 'HERE=${SELF%/*}' >> "$APPDIR/AppRun"
            echo 'export PATH="${HERE}/usr/bin/:${PATH}"' >> "$APPDIR/AppRun"
            echo 'export LD_LIBRARY_PATH="${HERE}/usr/lib/:${LD_LIBRARY_PATH}"' >> "$APPDIR/AppRun"
            echo 'exec "${HERE}/usr/bin/code" "$@"' >> "$APPDIR/AppRun"
            chmod +x "$APPDIR/AppRun"
            
            # Build AppImage
            ARCH=x86_64 ./appimagetool "$APPDIR" "HassanIDE-linux-x64-$VERSION.AppImage" || echo "AppImage creation failed"
          fi
        continue-on-error: true

      - name: "ğŸ“‹ List build outputs"
        run: |
          echo "=== .build directory ==="
          ls -la .build/ 2>/dev/null || echo "No .build directory"
          find .build -type f -name "*.deb" -o -name "*.rpm" 2>/dev/null || true
          echo ""
          echo "=== Parent directory ==="
          ls -la ../
          echo ""
          echo "=== Archive files ==="
          ls -la *.tar.gz *.AppImage 2>/dev/null || echo "No archives"

      - name: "ğŸ“¤ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-linux-${{ matrix.arch }}
          path: |
            .build/linux/deb/**/*.deb
            .build/linux/rpm/**/*.rpm
            HassanIDE-linux-${{ matrix.arch }}-*.tar.gz
            HassanIDE-linux-${{ matrix.arch }}-*.AppImage
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # ğŸŒ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ù„Ù„Ù…ÙˆÙ‚Ø¹ (ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¨Ù†Ø§Ø¡)
  # ===========================================================================
  upload-to-website:
    name: "ğŸŒ Upload to Website"
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build-windows
      - build-macos
      - build-linux
    if: |
      always() && 
      (needs.build-windows.result == 'success' || needs.build-macos.result == 'success' || needs.build-linux.result == 'success')
    
    permissions:
      contents: write
      pages: write

    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "ğŸ“¥ Download All Artifacts"
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts
        continue-on-error: true

      - name: "ğŸ“‹ Prepare Files for Website"
        id: prepare-files
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          BUILD_DATE=$(date +'%Y-%m-%d')
          DOWNLOADS_DIR="public_html/downloads"
          
          echo "ğŸ“¦ Version: $VERSION"
          echo "ğŸ“… Date: $BUILD_DATE"
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª
          mkdir -p "$DOWNLOADS_DIR/$VERSION"
          
          # Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª
          echo "=== Moving build artifacts ==="
          find downloaded-artifacts -type f \( \
            -name "*.exe" -o \
            -name "*.zip" -o \
            -name "*.dmg" -o \
            -name "*.deb" -o \
            -name "*.rpm" -o \
            -name "*.tar.gz" -o \
            -name "*.AppImage" \
          \) -exec cp {} "$DOWNLOADS_DIR/$VERSION/" \; 2>/dev/null || true
          
          # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª
          echo "=== Files in $DOWNLOADS_DIR/$VERSION ==="
          ls -lh "$DOWNLOADS_DIR/$VERSION/" 2>/dev/null || echo "No files found"
          
          # Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª
          FILE_COUNT=$(find "$DOWNLOADS_DIR/$VERSION" -type f 2>/dev/null | wc -l)
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: "ğŸ“ Update versions.json"
        if: steps.prepare-files.outputs.file_count > 0
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          BUILD_DATE=$(date +'%Y-%m-%d')
          DOWNLOADS_DIR="public_html/downloads"
          
          # Ø¥Ù†Ø´Ø§Ø¡ versions.json
          cat > "$DOWNLOADS_DIR/versions.json" << EOF
          {
            "latest": "$VERSION",
            "updated": "$BUILD_DATE",
            "versions": [
              {
                "version": "$VERSION",
                "date": "$BUILD_DATE",
                "stable": true,
                "downloads": {
                  "windows": {
                    "x64": "downloads/$VERSION/HassanIDE-win32-x64-$VERSION.zip",
                    "arm64": "downloads/$VERSION/HassanIDE-win32-arm64-$VERSION.zip"
                  },
                  "macos": {
                    "x64": "downloads/$VERSION/HassanIDE-darwin-x64-$VERSION.zip",
                    "arm64": "downloads/$VERSION/HassanIDE-darwin-arm64-$VERSION.zip"
                  },
                  "linux": {
                    "x64": "downloads/$VERSION/HassanIDE-linux-x64-$VERSION.tar.gz",
                    "arm64": "downloads/$VERSION/HassanIDE-linux-arm64-$VERSION.tar.gz"
                  }
                }
              }
            ]
          }
          EOF
          
          echo "âœ… versions.json updated"

      - name: "ğŸ“ Generate Download Page"
        if: steps.prepare-files.outputs.file_count > 0
        run: |
          DOWNLOADS_DIR="public_html/downloads"
          cp .github/templates/downloads-page.html "$DOWNLOADS_DIR/index.html"
          echo "âœ… Download page generated"

      - name: "ğŸ“¤ Commit and Push"
        if: steps.prepare-files.outputs.file_count > 0
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add public_html/downloads/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸš€ Auto-deploy: HassanIDE ${{ needs.prepare.outputs.version }}"
            git push origin main
            echo "âœ… Files pushed to repository"
          fi

      - name: "ğŸŒ Deploy to GitHub Pages"
        if: steps.prepare-files.outputs.file_count > 0
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public_html
          keep_files: true
        continue-on-error: true

  # ===========================================================================
  # ğŸ‰ Ø¥Ù†Ø´Ø§Ø¡ Release
  # ===========================================================================
  create-release:
    name: "ğŸ‰ Create Release"
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build-windows
      - build-macos
      - build-linux
    if: |
      always() &&
      (startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true') &&
      (needs.build-windows.result == 'success' || needs.build-macos.result == 'success' || needs.build-linux.result == 'success')
    
    permissions:
      contents: write

    steps:
      - name: "ğŸ“¥ Checkout code"
        uses: actions/checkout@v4

      - name: "ğŸ“¥ Download all artifacts"
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          merge-multiple: false

      - name: "ğŸ“‹ List downloaded artifacts"
        run: |
          echo "=== All artifacts ==="
          find artifacts -type f | head -100
          echo ""
          echo "=== Sizes ==="
          du -sh artifacts/*/ 2>/dev/null || echo "No artifact directories"

      - name: "ğŸ“ Prepare release files"
        run: |
          mkdir -p release_files
          
          find artifacts -type f \( \
            -name "*.exe" -o \
            -name "*.dmg" -o \
            -name "*.deb" -o \
            -name "*.rpm" -o \
            -name "*.AppImage" -o \
            -name "*.tar.gz" -o \
            -name "*.zip" \
          \) -exec cp {} release_files/ \;
          
          echo "=== Release files ==="
          ls -la release_files/

      - name: "ğŸ‰ Create GitHub Release"
        uses: softprops/action-gh-release@v2
        with:
          name: "ğŸš€ HassanIDE v${{ needs.prepare.outputs.version }}"
          tag_name: v${{ needs.prepare.outputs.version }}
          draft: false
          prerelease: ${{ contains(needs.prepare.outputs.version, 'dev') || contains(needs.prepare.outputs.version, 'alpha') || contains(needs.prepare.outputs.version, 'beta') }}
          generate_release_notes: true
          files: release_files/*
          body: |
            # ğŸš€ HassanIDE v${{ needs.prepare.outputs.version }}
            
            ## ğŸ“¥ Downloads
            
            ### ğŸªŸ Windows
            - **x64**: For most Windows PCs
            - **ARM64**: For Windows on ARM devices
            
            ### ğŸ macOS
            - **Intel (x64)**: For older Macs (pre-2020)
            - **Apple Silicon (ARM64)**: For M1/M2/M3/M4 Macs
            
            ### ğŸ§ Linux
            - **x64 DEB**: For Ubuntu/Debian
            - **x64 RPM**: For Fedora/RHEL
            - **x64 AppImage**: Universal Linux
            - **x64 tar.gz**: Portable
            
            ---
            
            ğŸ“… **Build Date:** ${{ needs.prepare.outputs.build_date }}
            ğŸ”— **Commit:** ${{ needs.prepare.outputs.short_sha }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # ğŸ“Š Ù…Ù„Ø®Øµ Ø§Ù„Ø¨Ù†Ø§Ø¡
  # ===========================================================================
  build-summary:
    name: "ğŸ“Š Build Summary"
    runs-on: ubuntu-latest
    needs:
      - prepare
      - build-windows
      - build-macos
      - build-linux
    if: always()

    steps:
      - name: "ğŸ“Š Display build results"
        run: |
          echo "=============================================="
          echo "       ğŸ“Š HassanIDE Build Summary"
          echo "=============================================="
          echo ""
          echo "ğŸ“¦ Version: ${{ needs.prepare.outputs.version }}"
          echo "ğŸ“… Date: $(date)"
          echo "ğŸ”— Commit: ${{ needs.prepare.outputs.short_sha }}"
          echo ""
          echo "=============================================="
          echo "       ğŸ“‹ Platform Status"
          echo "=============================================="
          echo ""
          echo "ğŸªŸ Windows: ${{ needs.build-windows.result }}"
          echo "ğŸ macOS:   ${{ needs.build-macos.result }}"
          echo "ğŸ§ Linux:   ${{ needs.build-linux.result }}"
          echo ""
          echo "=============================================="
          
          if [[ "${{ needs.build-windows.result }}" == "success" ]] || \
             [[ "${{ needs.build-macos.result }}" == "success" ]] || \
             [[ "${{ needs.build-linux.result }}" == "success" ]]; then
            echo "âœ… Build completed successfully for at least one platform!"
            exit 0
          else
            echo "âŒ All builds failed!"
            exit 1
          fi
