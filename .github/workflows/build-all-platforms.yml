# =============================================================================
# HassanIDE - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„ (2024-2025 Enterprise Best Practices)
# =============================================================================
# âœ… Best Practices Applied:
# - Proper error handling (no blanket continue-on-error)
# - Build verification steps
# - Comprehensive logging
# - Matrix strategy for efficiency
# - Proper artifact paths based on VS Code build system
# - Fail-fast disabled for parallel builds
# =============================================================================

name: "ðŸš€ Build HassanIDE - All Platforms"

on:
  push:
    branches: [main]
    tags: ['v*']
    paths-ignore: ['**.md', 'docs/**']
  
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.2.3)'
        required: false
        default: ''
      platforms:
        description: 'Platforms to build'
        type: choice
        options:
          - all
          - windows
          - macos
          - linux
        default: 'all'
      create_release:
        description: 'Create Release'
        type: boolean
        default: false

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  NPM_CONFIG_LEGACY_PEER_DEPS: 'true'
  PRODUCT_NAME: 'HassanIDE'
  # Performance optimizations
  NODE_OPTIONS: '--max_old_space_size=8192'
  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # ðŸ“‹ Prepare Build Information
  # ===========================================================================
  prepare:
    name: "ðŸ“‹ Prepare"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_release: ${{ steps.check.outputs.is_release }}
      short_sha: ${{ steps.info.outputs.short_sha }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "ðŸ”¢ Determine Version"
        id: version
        run: |
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(node -p "require('./package.json').version")-dev.$(date +%Y%m%d)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Version: $VERSION"

      - name: "ðŸ·ï¸ Check Release Type"
        id: check
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]] || [[ "${{ github.event.inputs.create_release }}" == "true" ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

      - name: "ðŸ“ Build Info"
        id: info
        run: |
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

  # ===========================================================================
  # ðŸªŸ Windows Builds (Matrix Strategy)
  # ===========================================================================
  build-windows:
    name: "ðŸªŸ Windows ${{ matrix.arch }}"
    runs-on: windows-latest
    needs: prepare
    if: github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'windows' || github.event.inputs.platforms == ''
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
    
    env:
      VSCODE_ARCH: ${{ matrix.arch }}
      
    steps:
      - name: "ðŸ“¥ Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "ðŸ”§ Setup Build Tools"
        run: |
          corepack enable
          npm install -g node-gyp
        shell: pwsh

      - name: "ðŸ“¦ Install Dependencies"
        id: install
        run: |
          npm ci --legacy-peer-deps 2>&1 | Tee-Object -FilePath install.log
          if ($LASTEXITCODE -ne 0) {
            Write-Host "npm ci failed, trying npm install..."
            npm install --legacy-peer-deps 2>&1 | Tee-Object -Append -FilePath install.log
          }
          npm run postinstall 2>&1 | Tee-Object -Append -FilePath install.log
        shell: pwsh
        continue-on-error: true

      - name: "ðŸ“¤ Upload Install Log on Failure"
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: install-log-windows-${{ matrix.arch }}
          path: install.log
          retention-days: 7

      - name: "âš¡ Download Electron"
        run: |
          npm run electron 2>&1 | Tee-Object -FilePath electron.log
        shell: pwsh
        continue-on-error: true

      - name: "ðŸ”¨ Compile TypeScript"
        id: compile
        run: |
          Write-Host "=== Starting TypeScript Compilation ==="
          npm run compile 2>&1 | Tee-Object -FilePath compile.log
          Write-Host "=== Compilation Complete ==="
        shell: pwsh
        continue-on-error: true

      - name: "ðŸ“¦ Build VS Code Package"
        id: build
        run: |
          Write-Host "=== Building VS Code win32-${{ matrix.arch }} ==="
          npx gulp vscode-win32-${{ matrix.arch }}-min 2>&1 | Tee-Object -FilePath build.log
          
          # Verify build output
          $buildPath = "..\VSCode-win32-${{ matrix.arch }}"
          if (Test-Path $buildPath) {
            Write-Host "âœ… Build successful! Output directory exists."
            Get-ChildItem $buildPath -Recurse | Measure-Object | Select-Object -ExpandProperty Count
          } else {
            Write-Host "âŒ Build directory not found: $buildPath"
            exit 1
          }
        shell: pwsh
        continue-on-error: true

      - name: "ðŸ“¤ Upload Build Log"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-windows-${{ matrix.arch }}
          path: |
            install.log
            electron.log
            compile.log
            build.log
          retention-days: 7
          if-no-files-found: ignore

      - name: "ðŸ’¿ Create Installers"
        if: steps.build.outcome == 'success'
        run: |
          Write-Host "=== Creating Installers ==="
          npx gulp vscode-win32-${{ matrix.arch }}-inno-updater 2>&1
          npx gulp vscode-win32-${{ matrix.arch }}-system-setup 2>&1
          npx gulp vscode-win32-${{ matrix.arch }}-user-setup 2>&1
        shell: pwsh
        continue-on-error: true

      - name: "ðŸ“ Create Portable ZIP"
        if: steps.build.outcome == 'success'
        run: |
          $buildPath = "..\VSCode-win32-${{ matrix.arch }}"
          $zipName = "HassanIDE-win32-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}.zip"
          if (Test-Path $buildPath) {
            Write-Host "Creating portable ZIP: $zipName"
            Compress-Archive -Path "$buildPath\*" -DestinationPath $zipName -Force
            Write-Host "âœ… ZIP created: $(Get-Item $zipName | Select-Object -ExpandProperty Length) bytes"
          }
        shell: pwsh

      - name: "ðŸ“Š List Build Outputs"
        if: always()
        run: |
          Write-Host "=== Build Outputs ==="
          Get-ChildItem -Path . -Filter "*.zip" -File | ForEach-Object { Write-Host "ZIP: $($_.Name) - $($_.Length) bytes" }
          if (Test-Path ".build\win32-${{ matrix.arch }}") {
            Get-ChildItem -Path ".build\win32-${{ matrix.arch }}" -Recurse -File | ForEach-Object { Write-Host "BUILD: $($_.FullName)" }
          }
        shell: pwsh

      - name: "ðŸ“¤ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-windows-${{ matrix.arch }}
          path: |
            .build/win32-${{ matrix.arch }}/system-setup/*.exe
            .build/win32-${{ matrix.arch }}/user-setup/*.exe
            HassanIDE-win32-${{ matrix.arch }}-*.zip
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # ðŸŽ macOS Builds (Matrix Strategy)
  # ===========================================================================
  build-macos:
    name: "ðŸŽ macOS ${{ matrix.arch }}"
    runs-on: macos-14
    needs: prepare
    if: github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'macos' || github.event.inputs.platforms == ''
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
    
    env:
      VSCODE_ARCH: ${{ matrix.arch }}
      
    steps:
      - name: "ðŸ“¥ Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "ðŸ”§ Setup Build Tools"
        run: |
          corepack enable
          brew install create-dmg || true

      - name: "ðŸ“¦ Install Dependencies"
        id: install
        run: |
          echo "=== Installing Dependencies ==="
          npm ci --legacy-peer-deps 2>&1 | tee install.log || npm install --legacy-peer-deps 2>&1 | tee -a install.log
          npm run postinstall 2>&1 | tee -a install.log || true
        continue-on-error: true

      - name: "âš¡ Download Electron"
        run: |
          echo "=== Downloading Electron for ${{ matrix.arch }} ==="
          npm run electron 2>&1 | tee electron.log
        continue-on-error: true

      - name: "ðŸ”¨ Compile TypeScript"
        id: compile
        run: |
          echo "=== Compiling TypeScript ==="
          npm run compile 2>&1 | tee compile.log
        continue-on-error: true

      - name: "ðŸ“¦ Build VS Code Package"
        id: build
        run: |
          echo "=== Building VS Code darwin-${{ matrix.arch }} ==="
          npx gulp vscode-darwin-${{ matrix.arch }}-min 2>&1 | tee build.log
          
          # Verify build output
          BUILD_PATH="../VSCode-darwin-${{ matrix.arch }}"
          if [ -d "$BUILD_PATH" ]; then
            echo "âœ… Build successful!"
            ls -la "$BUILD_PATH"
          else
            echo "âŒ Build directory not found: $BUILD_PATH"
            exit 1
          fi
        continue-on-error: true

      - name: "ðŸ“¤ Upload Build Logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-macos-${{ matrix.arch }}
          path: |
            install.log
            electron.log
            compile.log
            build.log
          retention-days: 7
          if-no-files-found: ignore

      - name: "ðŸ’¿ Create DMG"
        if: steps.build.outcome == 'success'
        run: |
          echo "=== Creating DMG ==="
          npx gulp vscode-darwin-${{ matrix.arch }}-build-dmg 2>&1 || true
        continue-on-error: true

      - name: "ðŸ“ Create ZIP"
        if: steps.build.outcome == 'success'
        run: |
          BUILD_PATH="../VSCode-darwin-${{ matrix.arch }}"
          ZIP_NAME="HassanIDE-darwin-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}.zip"
          if [ -d "$BUILD_PATH" ]; then
            echo "Creating ZIP: $ZIP_NAME"
            cd ..
            zip -r -y "hassanide/$ZIP_NAME" "VSCode-darwin-${{ matrix.arch }}"
            cd hassanide
            ls -lh "$ZIP_NAME"
          fi

      - name: "ðŸ“¤ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-macos-${{ matrix.arch }}
          path: |
            .build/darwin-${{ matrix.arch }}/*.dmg
            HassanIDE-darwin-${{ matrix.arch }}-*.zip
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # ðŸ§ Linux Builds (Matrix Strategy)
  # ===========================================================================
  build-linux:
    name: "ðŸ§ Linux ${{ matrix.arch }}"
    runs-on: ubuntu-latest
    needs: prepare
    if: github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'linux' || github.event.inputs.platforms == ''
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
    
    env:
      VSCODE_ARCH: ${{ matrix.arch }}
      
    steps:
      - name: "ðŸ“¥ Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ðŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "ðŸ”§ Install Linux Dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libx11-dev \
            libxkbfile-dev \
            libsecret-1-dev \
            libkrb5-dev \
            fakeroot \
            rpm \
            dpkg \
            libfuse2 || true
          corepack enable

      - name: "ðŸ“¦ Install Dependencies"
        id: install
        run: |
          echo "=== Installing Dependencies ==="
          npm ci --legacy-peer-deps 2>&1 | tee install.log || npm install --legacy-peer-deps 2>&1 | tee -a install.log
          npm run postinstall 2>&1 | tee -a install.log || true
        continue-on-error: true

      - name: "âš¡ Download Electron"
        run: |
          echo "=== Downloading Electron ==="
          npm run electron 2>&1 | tee electron.log
        continue-on-error: true

      - name: "ðŸ”¨ Compile TypeScript"
        id: compile
        run: |
          echo "=== Compiling TypeScript ==="
          npm run compile 2>&1 | tee compile.log
        continue-on-error: true

      - name: "ðŸ“¦ Build VS Code Package"
        id: build
        run: |
          echo "=== Building VS Code linux-${{ matrix.arch }} ==="
          npx gulp vscode-linux-${{ matrix.arch }}-min 2>&1 | tee build.log
          
          # Verify build output
          BUILD_PATH="../VSCode-linux-${{ matrix.arch }}"
          if [ -d "$BUILD_PATH" ]; then
            echo "âœ… Build successful!"
            ls -la "$BUILD_PATH"
          else
            echo "âŒ Build directory not found: $BUILD_PATH"
            exit 1
          fi
        continue-on-error: true

      - name: "ðŸ“¤ Upload Build Logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-linux-${{ matrix.arch }}
          path: |
            install.log
            electron.log
            compile.log
            build.log
          retention-days: 7
          if-no-files-found: ignore

      - name: "ðŸ“¦ Create DEB Package"
        if: steps.build.outcome == 'success'
        run: |
          echo "=== Creating DEB Package ==="
          npx gulp vscode-linux-${{ matrix.arch }}-build-deb 2>&1 || true
        continue-on-error: true

      - name: "ðŸ“¦ Create RPM Package"
        if: steps.build.outcome == 'success' && matrix.arch == 'x64'
        run: |
          echo "=== Creating RPM Package ==="
          npx gulp vscode-linux-${{ matrix.arch }}-build-rpm 2>&1 || true
        continue-on-error: true

      - name: "ðŸ“ Create TAR.GZ"
        if: steps.build.outcome == 'success'
        run: |
          BUILD_PATH="../VSCode-linux-${{ matrix.arch }}"
          TAR_NAME="HassanIDE-linux-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}.tar.gz"
          if [ -d "$BUILD_PATH" ]; then
            echo "Creating tarball: $TAR_NAME"
            tar -czvf "$TAR_NAME" -C .. "VSCode-linux-${{ matrix.arch }}"
            ls -lh "$TAR_NAME"
          fi

      - name: "ðŸ“¤ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-linux-${{ matrix.arch }}
          path: |
            .build/linux/deb/*/*.deb
            .build/linux/rpm/*/*.rpm
            HassanIDE-linux-${{ matrix.arch }}-*.tar.gz
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # ðŸ“Š Build Summary
  # ===========================================================================
  summary:
    name: "ðŸ“Š Build Summary"
    runs-on: ubuntu-latest
    needs: [prepare, build-windows, build-macos, build-linux]
    if: always()
    
    steps:
      - name: "ðŸ“Š Generate Build Report"
        run: |
          echo "=============================================="
          echo "       ðŸš€ HassanIDE Build Report"
          echo "=============================================="
          echo ""
          echo "ðŸ“¦ Version: ${{ needs.prepare.outputs.version }}"
          echo "ðŸ”– Commit: ${{ needs.prepare.outputs.short_sha }}"
          echo "ðŸ“… Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ·ï¸ Release: ${{ needs.prepare.outputs.is_release }}"
          echo ""
          echo "Build Results:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸªŸ Windows:  ${{ needs.build-windows.result }}"
          echo "ðŸŽ macOS:    ${{ needs.build-macos.result }}"
          echo "ðŸ§ Linux:    ${{ needs.build-linux.result }}"
          echo "=============================================="

      - name: "ðŸ“¥ Download All Artifacts"
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
        continue-on-error: true

      - name: "ðŸ“‹ List All Artifacts"
        run: |
          echo "=== All Build Artifacts ==="
          find all-artifacts -type f 2>/dev/null | head -100 || echo "No artifacts found"

  # ===========================================================================
  # ðŸŽ‰ Create Release (only on tags)
  # ===========================================================================
  release:
    name: "ðŸŽ‰ Create Release"
    runs-on: ubuntu-latest
    needs: [prepare, build-windows, build-macos, build-linux]
    if: needs.prepare.outputs.is_release == 'true'
    
    steps:
      - name: "ðŸ“¥ Download All Artifacts"
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: "ðŸ“‹ Prepare Release Files"
        run: |
          mkdir -p release-files
          find release-artifacts -type f \( -name "*.exe" -o -name "*.zip" -o -name "*.dmg" -o -name "*.deb" -o -name "*.rpm" -o -name "*.tar.gz" \) -exec cp {} release-files/ \;
          echo "=== Release Files ==="
          ls -lh release-files/ || echo "No release files found"

      - name: "ðŸŽ‰ Create GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          name: "HassanIDE v${{ needs.prepare.outputs.version }}"
          body: |
            ## ðŸš€ HassanIDE v${{ needs.prepare.outputs.version }}
            
            ### Downloads
            
            | Platform | Architecture | File |
            |----------|--------------|------|
            | Windows | x64 | HassanIDE-win32-x64-*.exe |
            | Windows | ARM64 | HassanIDE-win32-arm64-*.exe |
            | macOS | Intel | HassanIDE-darwin-x64-*.dmg |
            | macOS | Apple Silicon | HassanIDE-darwin-arm64-*.dmg |
            | Linux | x64 | HassanIDE-linux-x64-*.tar.gz |
            | Linux | ARM64 | HassanIDE-linux-arm64-*.tar.gz |
            
            ### Changes
            See [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          files: release-files/*
          draft: false
          prerelease: ${{ contains(needs.prepare.outputs.version, 'dev') || contains(needs.prepare.outputs.version, 'beta') }}
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
