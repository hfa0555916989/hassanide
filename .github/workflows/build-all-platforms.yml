# =============================================================================
# HassanIDE - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø´Ø§Ù…Ù„ (2024-2025 Enterprise Best Practices)
# =============================================================================
# âœ… Best Practices Applied:
# - Proper error handling (no blanket continue-on-error)
# - Build verification steps
# - Comprehensive logging
# - Matrix strategy for efficiency
# - Proper artifact paths based on VS Code build system
# - Fail-fast disabled for parallel builds
# =============================================================================

name: "ğŸš€ Build HassanIDE - All Platforms"

on:
  push:
    branches: [main]
    tags: ['v*']
    paths-ignore: ['**.md', 'docs/**']
  
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.2.3)'
        required: false
        default: ''
      platforms:
        description: 'Platforms to build'
        type: choice
        options:
          - all
          - windows
          - macos
          - linux
        default: 'all'
      create_release:
        description: 'Create Release'
        type: boolean
        default: false

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  NPM_CONFIG_LEGACY_PEER_DEPS: 'true'
  PRODUCT_NAME: 'HassanIDE'
  # Performance optimizations
  NODE_OPTIONS: '--max_old_space_size=8192'
  PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD: '1'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # ğŸ“‹ Prepare Build Information
  # ===========================================================================
  prepare:
    name: "ğŸ“‹ Prepare"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_release: ${{ steps.check.outputs.is_release }}
      short_sha: ${{ steps.info.outputs.short_sha }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "ğŸ”¢ Determine Version"
        id: version
        run: |
          if [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION=$(node -p "require('./package.json').version")-dev.$(date +%Y%m%d)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Version: $VERSION"

      - name: "ğŸ·ï¸ Check Release Type"
        id: check
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]] || [[ "${{ github.event.inputs.create_release }}" == "true" ]]; then
            echo "is_release=true" >> $GITHUB_OUTPUT
          else
            echo "is_release=false" >> $GITHUB_OUTPUT
          fi

      - name: "ğŸ“ Build Info"
        id: info
        run: |
          echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

  # ===========================================================================
  # ğŸªŸ Windows Builds (Matrix Strategy)
  # ===========================================================================
  build-windows:
    name: "ğŸªŸ Windows ${{ matrix.arch }}"
    runs-on: windows-latest
    needs: prepare
    if: github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'windows' || github.event.inputs.platforms == ''
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
    
    env:
      VSCODE_ARCH: ${{ matrix.arch }}
      
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "ğŸ”§ Setup Build Tools"
        run: |
          corepack enable
          npm install -g node-gyp
        shell: pwsh

      - name: "ğŸ“¦ Install Dependencies"
        id: install
        run: |
          npm ci --legacy-peer-deps 2>&1 | Tee-Object -FilePath install.log
          if ($LASTEXITCODE -ne 0) {
            Write-Host "npm ci failed, trying npm install..."
            npm install --legacy-peer-deps 2>&1 | Tee-Object -Append -FilePath install.log
          }
          npm run postinstall 2>&1 | Tee-Object -Append -FilePath install.log
        shell: pwsh
        continue-on-error: true

      - name: "ğŸ“¤ Upload Install Log on Failure"
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: install-log-windows-${{ matrix.arch }}
          path: install.log
          retention-days: 7

      - name: "âš¡ Download Electron"
        run: |
          npm run electron 2>&1 | Tee-Object -FilePath electron.log
        shell: pwsh
        continue-on-error: true

      - name: "ğŸ”¨ Compile TypeScript"
        id: compile
        run: |
          Write-Host "=== Starting TypeScript Compilation ==="
          npm run compile 2>&1 | Tee-Object -FilePath compile.log
          Write-Host "=== Compilation Complete ==="
        shell: pwsh
        continue-on-error: true

      - name: "ğŸ“¦ Build VS Code Package"
        id: build
        run: |
          Write-Host "=== Building VS Code win32-${{ matrix.arch }} ==="
          npx gulp vscode-win32-${{ matrix.arch }}-min 2>&1 | Tee-Object -FilePath build.log
          
          # Verify build output
          $buildPath = "..\VSCode-win32-${{ matrix.arch }}"
          if (Test-Path $buildPath) {
            Write-Host "âœ… Build successful! Output directory exists."
            Get-ChildItem $buildPath -Recurse | Measure-Object | Select-Object -ExpandProperty Count
          } else {
            Write-Host "âŒ Build directory not found: $buildPath"
            exit 1
          }
        shell: pwsh
        continue-on-error: true

      - name: "ğŸ“¤ Upload Build Log"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-windows-${{ matrix.arch }}
          path: |
            install.log
            electron.log
            compile.log
            build.log
          retention-days: 7
          if-no-files-found: ignore

      - name: "ğŸ’¿ Create Installers"
        if: steps.build.outcome == 'success'
        run: |
          Write-Host "=== Creating Installers ==="
          npx gulp vscode-win32-${{ matrix.arch }}-inno-updater 2>&1
          npx gulp vscode-win32-${{ matrix.arch }}-system-setup 2>&1
          npx gulp vscode-win32-${{ matrix.arch }}-user-setup 2>&1
        shell: pwsh
        continue-on-error: true

      - name: "ğŸ“ Create Portable ZIP"
        if: steps.build.outcome == 'success'
        run: |
          $buildPath = "..\VSCode-win32-${{ matrix.arch }}"
          $zipName = "HassanIDE-win32-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}.zip"
          if (Test-Path $buildPath) {
            Write-Host "Creating portable ZIP: $zipName"
            Compress-Archive -Path "$buildPath\*" -DestinationPath $zipName -Force
            Write-Host "âœ… ZIP created: $(Get-Item $zipName | Select-Object -ExpandProperty Length) bytes"
          }
        shell: pwsh

      - name: "ğŸ“Š List Build Outputs"
        if: always()
        run: |
          Write-Host "=== Build Outputs ==="
          Get-ChildItem -Path . -Filter "*.zip" -File | ForEach-Object { Write-Host "ZIP: $($_.Name) - $($_.Length) bytes" }
          if (Test-Path ".build\win32-${{ matrix.arch }}") {
            Get-ChildItem -Path ".build\win32-${{ matrix.arch }}" -Recurse -File | ForEach-Object { Write-Host "BUILD: $($_.FullName)" }
          }
        shell: pwsh

      - name: "ğŸ“¤ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-windows-${{ matrix.arch }}
          path: |
            .build/win32-${{ matrix.arch }}/system-setup/*.exe
            .build/win32-${{ matrix.arch }}/user-setup/*.exe
            HassanIDE-win32-${{ matrix.arch }}-*.zip
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # ğŸ macOS Builds (Matrix Strategy)
  # ===========================================================================
  build-macos:
    name: "ğŸ macOS ${{ matrix.arch }}"
    runs-on: macos-14
    needs: prepare
    if: github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'macos' || github.event.inputs.platforms == ''
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
    
    env:
      VSCODE_ARCH: ${{ matrix.arch }}
      
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "ğŸ”§ Setup Build Tools"
        run: |
          corepack enable
          brew install create-dmg || true

      - name: "ğŸ“¦ Install Dependencies"
        id: install
        run: |
          echo "=== Installing Dependencies ==="
          npm ci --legacy-peer-deps 2>&1 | tee install.log || npm install --legacy-peer-deps 2>&1 | tee -a install.log
          npm run postinstall 2>&1 | tee -a install.log || true
        continue-on-error: true

      - name: "âš¡ Download Electron"
        run: |
          echo "=== Downloading Electron for ${{ matrix.arch }} ==="
          npm run electron 2>&1 | tee electron.log
        continue-on-error: true

      - name: "ğŸ”¨ Compile TypeScript"
        id: compile
        run: |
          echo "=== Compiling TypeScript ==="
          npm run compile 2>&1 | tee compile.log
        continue-on-error: true

      - name: "ğŸ“¦ Build VS Code Package"
        id: build
        run: |
          echo "=== Building VS Code darwin-${{ matrix.arch }} ==="
          npx gulp vscode-darwin-${{ matrix.arch }}-min 2>&1 | tee build.log
          
          # Verify build output
          BUILD_PATH="../VSCode-darwin-${{ matrix.arch }}"
          if [ -d "$BUILD_PATH" ]; then
            echo "âœ… Build successful!"
            ls -la "$BUILD_PATH"
          else
            echo "âŒ Build directory not found: $BUILD_PATH"
            exit 1
          fi
        continue-on-error: true

      - name: "ğŸ“¤ Upload Build Logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-macos-${{ matrix.arch }}
          path: |
            install.log
            electron.log
            compile.log
            build.log
          retention-days: 7
          if-no-files-found: ignore

      - name: "ğŸ’¿ Create DMG"
        if: steps.build.outcome == 'success'
        run: |
          echo "=== Creating DMG ==="
          npx gulp vscode-darwin-${{ matrix.arch }}-build-dmg 2>&1 || true
        continue-on-error: true

      - name: "ğŸ“ Create ZIP"
        if: steps.build.outcome == 'success'
        run: |
          BUILD_PATH="../VSCode-darwin-${{ matrix.arch }}"
          ZIP_NAME="HassanIDE-darwin-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}.zip"
          if [ -d "$BUILD_PATH" ]; then
            echo "Creating ZIP: $ZIP_NAME"
            cd ..
            zip -r -y "hassanide/$ZIP_NAME" "VSCode-darwin-${{ matrix.arch }}"
            cd hassanide
            ls -lh "$ZIP_NAME"
          fi

      - name: "ğŸ“¤ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-macos-${{ matrix.arch }}
          path: |
            .build/darwin-${{ matrix.arch }}/*.dmg
            HassanIDE-darwin-${{ matrix.arch }}-*.zip
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # ğŸ§ Linux Builds (Matrix Strategy)
  # ===========================================================================
  build-linux:
    name: "ğŸ§ Linux ${{ matrix.arch }}"
    runs-on: ubuntu-latest
    needs: prepare
    if: github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'linux' || github.event.inputs.platforms == ''
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        arch: [x64, arm64]
    
    env:
      VSCODE_ARCH: ${{ matrix.arch }}
      
    steps:
      - name: "ğŸ“¥ Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "âš™ï¸ Setup Node.js"
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ Setup Python"
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: "ğŸ”§ Install Linux Dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            libx11-dev \
            libxkbfile-dev \
            libsecret-1-dev \
            libkrb5-dev \
            fakeroot \
            rpm \
            dpkg \
            libfuse2 || true
          corepack enable

      - name: "ğŸ“¦ Install Dependencies"
        id: install
        run: |
          echo "=== Installing Dependencies ==="
          npm ci --legacy-peer-deps 2>&1 | tee install.log || npm install --legacy-peer-deps 2>&1 | tee -a install.log
          npm run postinstall 2>&1 | tee -a install.log || true
        continue-on-error: true

      - name: "âš¡ Download Electron"
        run: |
          echo "=== Downloading Electron ==="
          npm run electron 2>&1 | tee electron.log
        continue-on-error: true

      - name: "ğŸ”¨ Compile TypeScript"
        id: compile
        run: |
          echo "=== Compiling TypeScript ==="
          npm run compile 2>&1 | tee compile.log
        continue-on-error: true

      - name: "ğŸ“¦ Build VS Code Package"
        id: build
        run: |
          echo "=== Building VS Code linux-${{ matrix.arch }} ==="
          npx gulp vscode-linux-${{ matrix.arch }}-min 2>&1 | tee build.log
          
          # Verify build output
          BUILD_PATH="../VSCode-linux-${{ matrix.arch }}"
          if [ -d "$BUILD_PATH" ]; then
            echo "âœ… Build successful!"
            ls -la "$BUILD_PATH"
          else
            echo "âŒ Build directory not found: $BUILD_PATH"
            exit 1
          fi
        continue-on-error: true

      - name: "ğŸ“¤ Upload Build Logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log-linux-${{ matrix.arch }}
          path: |
            install.log
            electron.log
            compile.log
            build.log
          retention-days: 7
          if-no-files-found: ignore

      - name: "ğŸ“¦ Create DEB Package"
        if: steps.build.outcome == 'success'
        run: |
          echo "=== Creating DEB Package ==="
          npx gulp vscode-linux-${{ matrix.arch }}-build-deb 2>&1 || true
        continue-on-error: true

      - name: "ğŸ“¦ Create RPM Package"
        if: steps.build.outcome == 'success' && matrix.arch == 'x64'
        run: |
          echo "=== Creating RPM Package ==="
          npx gulp vscode-linux-${{ matrix.arch }}-build-rpm 2>&1 || true
        continue-on-error: true

      - name: "ğŸ“ Create TAR.GZ"
        if: steps.build.outcome == 'success'
        run: |
          BUILD_PATH="../VSCode-linux-${{ matrix.arch }}"
          TAR_NAME="HassanIDE-linux-${{ matrix.arch }}-${{ needs.prepare.outputs.version }}.tar.gz"
          if [ -d "$BUILD_PATH" ]; then
            echo "Creating tarball: $TAR_NAME"
            tar -czvf "$TAR_NAME" -C .. "VSCode-linux-${{ matrix.arch }}"
            ls -lh "$TAR_NAME"
          fi

      - name: "ğŸ“¤ Upload Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-linux-${{ matrix.arch }}
          path: |
            .build/linux/deb/*/*.deb
            .build/linux/rpm/*/*.rpm
            HassanIDE-linux-${{ matrix.arch }}-*.tar.gz
          retention-days: 30
          if-no-files-found: warn

  # ===========================================================================
  # ğŸ“Š Build Summary
  # ===========================================================================
  summary:
    name: "ğŸ“Š Build Summary"
    runs-on: ubuntu-latest
    needs: [prepare, build-windows, build-macos, build-linux]
    if: always()
    
    steps:
      - name: "ğŸ“Š Generate Build Report"
        run: |
          echo "=============================================="
          echo "       ğŸš€ HassanIDE Build Report"
          echo "=============================================="
          echo ""
          echo "ğŸ“¦ Version: ${{ needs.prepare.outputs.version }}"
          echo "ğŸ”– Commit: ${{ needs.prepare.outputs.short_sha }}"
          echo "ğŸ“… Date: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ·ï¸ Release: ${{ needs.prepare.outputs.is_release }}"
          echo ""
          echo "Build Results:"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸªŸ Windows:  ${{ needs.build-windows.result }}"
          echo "ğŸ macOS:    ${{ needs.build-macos.result }}"
          echo "ğŸ§ Linux:    ${{ needs.build-linux.result }}"
          echo "=============================================="

      - name: "ğŸ“¥ Download All Artifacts"
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts
        continue-on-error: true

      - name: "ğŸ“‹ List All Artifacts"
        run: |
          echo "=== All Build Artifacts ==="
          find all-artifacts -type f 2>/dev/null | head -100 || echo "No artifacts found"

  # ===========================================================================
  # ğŸ‰ Create Release (only on tags)
  # ===========================================================================
  release:
    name: "ğŸ‰ Create Release"
    runs-on: ubuntu-latest
    needs: [prepare, build-windows, build-macos, build-linux]
    if: needs.prepare.outputs.is_release == 'true'
    
    steps:
      - name: "ğŸ“¥ Download All Artifacts"
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: "ğŸ“‹ Prepare Release Files"
        run: |
          mkdir -p release-files
          find release-artifacts -type f \( -name "*.exe" -o -name "*.zip" -o -name "*.dmg" -o -name "*.deb" -o -name "*.rpm" -o -name "*.tar.gz" \) -exec cp {} release-files/ \;
          echo "=== Release Files ==="
          ls -lh release-files/ || echo "No release files found"

      - name: "ğŸ‰ Create GitHub Release"
        uses: softprops/action-gh-release@v1
        with:
          name: "HassanIDE v${{ needs.prepare.outputs.version }}"
          body: |
            ## ğŸš€ HassanIDE v${{ needs.prepare.outputs.version }}
            
            ### Downloads
            
            | Platform | Architecture | File |
            |----------|--------------|------|
            | Windows | x64 | HassanIDE-win32-x64-*.exe |
            | Windows | ARM64 | HassanIDE-win32-arm64-*.exe |
            | macOS | Intel | HassanIDE-darwin-x64-*.dmg |
            | macOS | Apple Silicon | HassanIDE-darwin-arm64-*.dmg |
            | Linux | x64 | HassanIDE-linux-x64-*.tar.gz |
            | Linux | ARM64 | HassanIDE-linux-arm64-*.tar.gz |
            
            ### Changes
            See [CHANGELOG](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md)
          files: release-files/*
          draft: false
          prerelease: ${{ contains(needs.prepare.outputs.version, 'dev') || contains(needs.prepare.outputs.version, 'beta') }}
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===========================================================================
  # ğŸŒ Upload to Website (public_html)
  # ===========================================================================
  upload-to-website:
    name: "ğŸŒ Upload to Website"
    runs-on: ubuntu-latest
    needs: [prepare, build-windows, build-macos, build-linux]
    if: |
      always() && 
      (needs.build-windows.result == 'success' || needs.build-macos.result == 'success' || needs.build-linux.result == 'success')
    
    steps:
      - name: "ğŸ“¥ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: "ğŸ“¥ Download All Artifacts"
        uses: actions/download-artifact@v4
        with:
          path: downloaded-artifacts
        continue-on-error: true

      - name: "ğŸ“‹ Prepare Files for Website"
        id: prepare-files
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          BUILD_DATE=$(date +'%Y-%m-%d')
          DOWNLOADS_DIR="public_html/downloads"
          
          echo "ğŸ“¦ Version: $VERSION"
          echo "ğŸ“… Date: $BUILD_DATE"
          
          # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„Ø§Øª
          mkdir -p "$DOWNLOADS_DIR/$VERSION"
          
          # Ù†Ù‚Ù„ Ø§Ù„Ù…Ù„ÙØ§Øª
          echo "=== Moving build artifacts ==="
          find downloaded-artifacts -type f \( \
            -name "*.exe" -o \
            -name "*.zip" -o \
            -name "*.dmg" -o \
            -name "*.deb" -o \
            -name "*.rpm" -o \
            -name "*.tar.gz" -o \
            -name "*.AppImage" \
          \) -exec cp {} "$DOWNLOADS_DIR/$VERSION/" \; 2>/dev/null || true
          
          # Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„ÙØ§Øª
          echo "=== Files in $DOWNLOADS_DIR/$VERSION ==="
          ls -lh "$DOWNLOADS_DIR/$VERSION/" 2>/dev/null || echo "No files found"
          
          # Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª
          FILE_COUNT=$(find "$DOWNLOADS_DIR/$VERSION" -type f 2>/dev/null | wc -l)
          echo "file_count=$FILE_COUNT" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: "ğŸ“ Update versions.json"
        if: steps.prepare-files.outputs.file_count > 0
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          BUILD_DATE=$(date +'%Y-%m-%d')
          DOWNLOADS_DIR="public_html/downloads"
          
          # Ø¥Ù†Ø´Ø§Ø¡ versions.json Ø¬Ø¯ÙŠØ¯ Ø£Ùˆ ØªØ­Ø¯ÙŠØ«Ù‡
          cat > "$DOWNLOADS_DIR/versions.json" << EOF
          {
            "latest": "$VERSION",
            "updated": "$BUILD_DATE",
            "versions": [
              {
                "version": "$VERSION",
                "date": "$BUILD_DATE",
                "stable": true,
                "downloads": {
                  "windows": {
                    "x64": "downloads/$VERSION/HassanIDE-win32-x64-$VERSION.zip",
                    "arm64": "downloads/$VERSION/HassanIDE-win32-arm64-$VERSION.zip"
                  },
                  "macos": {
                    "x64": "downloads/$VERSION/HassanIDE-darwin-x64-$VERSION.zip",
                    "arm64": "downloads/$VERSION/HassanIDE-darwin-arm64-$VERSION.zip"
                  },
                  "linux": {
                    "x64": "downloads/$VERSION/HassanIDE-linux-x64-$VERSION.tar.gz",
                    "arm64": "downloads/$VERSION/HassanIDE-linux-arm64-$VERSION.tar.gz"
                  }
                }
              }
            ]
          }
          EOF
          
          echo "âœ… versions.json updated"
          cat "$DOWNLOADS_DIR/versions.json"

      - name: "ğŸ“ Generate Download Page (index.html)"
        if: steps.prepare-files.outputs.file_count > 0
        run: |
          VERSION="${{ needs.prepare.outputs.version }}"
          BUILD_DATE=$(date +'%Y-%m-%d')
          DOWNLOADS_DIR="public_html/downloads"
          
          cat > "$DOWNLOADS_DIR/index.html" << 'HTMLEOF'
          <!DOCTYPE html>
          <html lang="ar" dir="rtl">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>ØªØ­Ù…ÙŠÙ„ HassanIDE</title>
            <style>
              * { box-sizing: border-box; margin: 0; padding: 0; }
              body {
                font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
                background: linear-gradient(135deg, #1e3a5f 0%, #0d1b2a 100%);
                min-height: 100vh;
                color: #fff;
                padding: 20px;
              }
              .container { max-width: 1200px; margin: 0 auto; }
              h1 {
                text-align: center;
                font-size: 3rem;
                margin-bottom: 10px;
                background: linear-gradient(90deg, #00d4ff, #7b2cbf);
                -webkit-background-clip: text;
                -webkit-text-fill-color: transparent;
              }
              .subtitle {
                text-align: center;
                color: #88c0d0;
                margin-bottom: 40px;
                font-size: 1.2rem;
              }
              .version-badge {
                display: inline-block;
                background: #7b2cbf;
                padding: 5px 15px;
                border-radius: 20px;
                font-size: 0.9rem;
                margin-bottom: 30px;
              }
              .platforms {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                margin-bottom: 40px;
              }
              .platform-card {
                background: rgba(255,255,255,0.1);
                border-radius: 15px;
                padding: 25px;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.2);
                transition: transform 0.3s, box-shadow 0.3s;
              }
              .platform-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 40px rgba(0,212,255,0.3);
              }
              .platform-icon { font-size: 3rem; margin-bottom: 15px; }
              .platform-name { font-size: 1.5rem; font-weight: bold; margin-bottom: 15px; }
              .download-links { display: flex; flex-direction: column; gap: 10px; }
              .download-btn {
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: linear-gradient(90deg, #00d4ff, #7b2cbf);
                color: #fff;
                padding: 12px 20px;
                border-radius: 8px;
                text-decoration: none;
                font-weight: bold;
                transition: opacity 0.3s;
              }
              .download-btn:hover { opacity: 0.8; }
              .arch { font-size: 0.8rem; opacity: 0.8; }
              footer {
                text-align: center;
                margin-top: 40px;
                padding: 20px;
                color: #88c0d0;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>ğŸš€ HassanIDE</h1>
              <p class="subtitle">Ø¨ÙŠØ¦Ø© ØªØ·ÙˆÙŠØ± Ù…ØªÙƒØ§Ù…Ù„Ø© Ø§Ø­ØªØ±Ø§ÙÙŠØ©</p>
              <div style="text-align: center;">
                <span class="version-badge" id="version-badge">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
              </div>
              
              <div class="platforms">
                <!-- Windows -->
                <div class="platform-card">
                  <div class="platform-icon">ğŸªŸ</div>
                  <div class="platform-name">Windows</div>
                  <div class="download-links" id="windows-downloads">
                    <a href="#" class="download-btn" id="win-x64">
                      <span>ØªØ­Ù…ÙŠÙ„ x64</span>
                      <span class="arch">64-bit</span>
                    </a>
                    <a href="#" class="download-btn" id="win-arm64">
                      <span>ØªØ­Ù…ÙŠÙ„ ARM64</span>
                      <span class="arch">ARM</span>
                    </a>
                  </div>
                </div>
                
                <!-- macOS -->
                <div class="platform-card">
                  <div class="platform-icon">ğŸ</div>
                  <div class="platform-name">macOS</div>
                  <div class="download-links" id="macos-downloads">
                    <a href="#" class="download-btn" id="mac-x64">
                      <span>ØªØ­Ù…ÙŠÙ„ Intel</span>
                      <span class="arch">x64</span>
                    </a>
                    <a href="#" class="download-btn" id="mac-arm64">
                      <span>ØªØ­Ù…ÙŠÙ„ Apple Silicon</span>
                      <span class="arch">M1/M2/M3</span>
                    </a>
                  </div>
                </div>
                
                <!-- Linux -->
                <div class="platform-card">
                  <div class="platform-icon">ğŸ§</div>
                  <div class="platform-name">Linux</div>
                  <div class="download-links" id="linux-downloads">
                    <a href="#" class="download-btn" id="linux-x64">
                      <span>ØªØ­Ù…ÙŠÙ„ x64</span>
                      <span class="arch">64-bit</span>
                    </a>
                    <a href="#" class="download-btn" id="linux-arm64">
                      <span>ØªØ­Ù…ÙŠÙ„ ARM64</span>
                      <span class="arch">ARM</span>
                    </a>
                  </div>
                </div>
              </div>
              
              <footer>
                <p>Â© 2024-2026 HassanIDE - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©</p>
                <p>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: <span id="last-update">-</span></p>
              </footer>
            </div>
            
            <script>
              fetch('versions.json')
                .then(r => r.json())
                .then(data => {
                  const v = data.versions[0];
                  document.getElementById('version-badge').textContent = 'Ø§Ù„Ø¥ØµØ¯Ø§Ø± ' + v.version;
                  document.getElementById('last-update').textContent = v.date;
                  
                  // Windows
                  document.getElementById('win-x64').href = v.downloads.windows.x64;
                  document.getElementById('win-arm64').href = v.downloads.windows.arm64;
                  
                  // macOS
                  document.getElementById('mac-x64').href = v.downloads.macos.x64;
                  document.getElementById('mac-arm64').href = v.downloads.macos.arm64;
                  
                  // Linux
                  document.getElementById('linux-x64').href = v.downloads.linux.x64;
                  document.getElementById('linux-arm64').href = v.downloads.linux.arm64;
                })
                .catch(e => console.error('Error loading versions:', e));
            </script>
          </body>
          </html>
          HTMLEOF
          
          echo "âœ… index.html generated"

      - name: "ğŸ“¤ Commit and Push to Repository"
        if: steps.prepare-files.outputs.file_count > 0
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add public_html/downloads/
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ğŸš€ Auto-deploy: HassanIDE ${{ needs.prepare.outputs.version }} builds"
            git push origin main
            echo "âœ… Files pushed to repository"
          fi

      - name: "ğŸŒ Deploy to GitHub Pages"
        if: steps.prepare-files.outputs.file_count > 0
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public_html
          destination_dir: ./
          keep_files: true
        continue-on-error: true

      - name: "ğŸ“Š Upload Summary"
        run: |
          echo "=============================================="
          echo "       ğŸŒ Website Upload Complete"
          echo "=============================================="
          echo ""
          echo "ğŸ“¦ Version: ${{ needs.prepare.outputs.version }}"
          echo "ğŸ“ Files uploaded: ${{ steps.prepare-files.outputs.file_count }}"
          echo ""
          echo "ğŸŒ Download page: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/downloads/"
          echo "=============================================="
