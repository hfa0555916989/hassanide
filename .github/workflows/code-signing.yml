# =============================================================================
# HassanIDE - Code Signing & Notarization
# =============================================================================
# ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„ÙƒÙˆØ¯ Ù„Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø®ØªÙ„ÙØ©:
# - Windows: Authenticode signing
# - macOS: Apple Developer signing + Notarization
# - Linux: GPG signing
# =============================================================================

name: "ğŸ” Code Signing"

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
      platform:
        required: true
        type: string
    secrets:
      # Windows
      WINDOWS_CERTIFICATE_P12:
        required: false
      WINDOWS_CERTIFICATE_PASSWORD:
        required: false
      # macOS
      APPLE_CERTIFICATE_P12:
        required: false
      APPLE_CERTIFICATE_PASSWORD:
        required: false
      APPLE_ID:
        required: false
      APPLE_ID_PASSWORD:
        required: false
      APPLE_TEAM_ID:
        required: false
      # Linux
      GPG_PRIVATE_KEY:
        required: false
      GPG_PASSPHRASE:
        required: false

  workflow_dispatch:
    inputs:
      version:
        description: 'Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ù„Ù„ØªÙˆÙ‚ÙŠØ¹'
        required: true
      platform:
        description: 'Ø§Ù„Ù…Ù†ØµØ©'
        required: true
        type: choice
        options:
          - windows
          - macos
          - linux
          - all

jobs:
  # ===========================================================================
  # ØªÙˆÙ‚ÙŠØ¹ Windows (Authenticode)
  # ===========================================================================
  sign-windows:
    name: "ğŸ” Sign Windows"
    runs-on: windows-latest
    if: inputs.platform == 'windows' || inputs.platform == 'all'
    
    steps:
      - name: "ğŸ“¥ Download Windows Artifacts"
        uses: actions/download-artifact@v4
        with:
          pattern: hassanide-windows-*
          path: unsigned
        continue-on-error: true

      - name: "ğŸ” Setup Certificate"
        if: env.WINDOWS_CERTIFICATE_P12 != ''
        run: |
          # ÙÙƒ ØªØ´ÙÙŠØ± Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
          $certBytes = [Convert]::FromBase64String("${{ secrets.WINDOWS_CERTIFICATE_P12 }}")
          [IO.File]::WriteAllBytes("certificate.p12", $certBytes)
          
          # Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
          $password = ConvertTo-SecureString -String "${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}" -AsPlainText -Force
          Import-PfxCertificate -FilePath certificate.p12 -CertStoreLocation Cert:\CurrentUser\My -Password $password
          
          # Ø­Ø°Ù Ù…Ù„Ù Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
          Remove-Item certificate.p12
        shell: pwsh
        env:
          WINDOWS_CERTIFICATE_P12: ${{ secrets.WINDOWS_CERTIFICATE_P12 }}

      - name: "ğŸ” Sign EXE Files"
        if: env.WINDOWS_CERTIFICATE_P12 != ''
        run: |
          $files = Get-ChildItem -Path unsigned -Filter "*.exe" -Recurse
          foreach ($file in $files) {
            Write-Host "Signing: $($file.FullName)"
            
            # ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ù„Ù Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… signtool
            & "C:\Program Files (x86)\Windows Kits\10\bin\10.0.22621.0\x64\signtool.exe" sign `
              /fd SHA256 `
              /tr "http://timestamp.digicert.com" `
              /td SHA256 `
              /n "Hassan Tech" `
              "$($file.FullName)"
            
            if ($LASTEXITCODE -ne 0) {
              Write-Warning "Failed to sign: $($file.Name)"
            }
          }
        shell: pwsh
        continue-on-error: true
        env:
          WINDOWS_CERTIFICATE_P12: ${{ secrets.WINDOWS_CERTIFICATE_P12 }}

      - name: "ğŸ“¤ Upload Signed Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-windows-signed
          path: unsigned/**/*.exe
          retention-days: 30

  # ===========================================================================
  # ØªÙˆÙ‚ÙŠØ¹ macOS (Apple Developer)
  # ===========================================================================
  sign-macos:
    name: "ğŸ” Sign macOS"
    runs-on: macos-14
    if: inputs.platform == 'macos' || inputs.platform == 'all'
    
    steps:
      - name: "ğŸ“¥ Download macOS Artifacts"
        uses: actions/download-artifact@v4
        with:
          pattern: hassanide-macos-*
          path: unsigned
        continue-on-error: true

      - name: "ğŸ” Setup Keychain"
        if: env.APPLE_CERTIFICATE_P12 != ''
        run: |
          # Ø¥Ù†Ø´Ø§Ø¡ keychain Ù…Ø¤Ù‚Øª
          security create-keychain -p "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" build.keychain
          
          # Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
          echo "${{ secrets.APPLE_CERTIFICATE_P12 }}" | base64 --decode > certificate.p12
          security import certificate.p12 -k build.keychain -P "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" -T /usr/bin/codesign
          rm certificate.p12
          
          # Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„
          security set-key-partition-list -S apple-tool:,apple: -s -k "${{ secrets.APPLE_CERTIFICATE_PASSWORD }}" build.keychain
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}

      - name: "ğŸ” Sign App Bundle"
        if: env.APPLE_CERTIFICATE_P12 != ''
        run: |
          for zip in unsigned/**/*.zip; do
            if [ -f "$zip" ]; then
              echo "Processing: $zip"
              
              # ÙÙƒ Ø§Ù„Ø¶ØºØ·
              unzip -q "$zip" -d temp_app
              
              # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† .app
              APP_PATH=$(find temp_app -name "*.app" -type d | head -1)
              
              if [ -n "$APP_PATH" ]; then
                echo "Signing: $APP_PATH"
                
                # ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
                codesign --deep --force --verify --verbose \
                  --sign "Developer ID Application: Hassan Tech" \
                  --options runtime \
                  --entitlements entitlements.plist \
                  "$APP_PATH" || echo "Signing failed for $APP_PATH"
                
                # Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶ØºØ·
                zip -r -y "${zip%.zip}-signed.zip" temp_app/*
              fi
              
              rm -rf temp_app
            fi
          done
        continue-on-error: true
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}

      - name: "ğŸ“‹ Notarize App"
        if: env.APPLE_ID != ''
        run: |
          for zip in unsigned/**/*-signed.zip; do
            if [ -f "$zip" ]; then
              echo "Notarizing: $zip"
              
              # Ø±ÙØ¹ Ù„Ù„Ù€ Notarization
              xcrun notarytool submit "$zip" \
                --apple-id "${{ secrets.APPLE_ID }}" \
                --password "${{ secrets.APPLE_ID_PASSWORD }}" \
                --team-id "${{ secrets.APPLE_TEAM_ID }}" \
                --wait || echo "Notarization failed for $zip"
              
              # Staple the notarization
              xcrun stapler staple "$zip" || true
            fi
          done
        continue-on-error: true
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}

      - name: "ğŸ“¤ Upload Signed Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-macos-signed
          path: unsigned/**/*-signed.zip
          retention-days: 30

  # ===========================================================================
  # ØªÙˆÙ‚ÙŠØ¹ Linux (GPG)
  # ===========================================================================
  sign-linux:
    name: "ğŸ” Sign Linux"
    runs-on: ubuntu-latest
    if: inputs.platform == 'linux' || inputs.platform == 'all'
    
    steps:
      - name: "ğŸ“¥ Download Linux Artifacts"
        uses: actions/download-artifact@v4
        with:
          pattern: hassanide-linux-*
          path: unsigned
        continue-on-error: true

      - name: "ğŸ” Setup GPG"
        if: env.GPG_PRIVATE_KEY != ''
        run: |
          # Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø§Øµ
          echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
          
          # Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù Ø§Ù„Ù…ÙØªØ§Ø­
          GPG_KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep sec | head -1 | awk '{print $2}' | cut -d'/' -f2)
          echo "GPG_KEY_ID=$GPG_KEY_ID" >> $GITHUB_ENV
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: "ğŸ” Sign Packages"
        if: env.GPG_PRIVATE_KEY != ''
        run: |
          for file in unsigned/**/*.{deb,rpm,tar.gz,AppImage}; do
            if [ -f "$file" ]; then
              echo "Signing: $file"
              
              # ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ù…Ù„Ù
              gpg --batch --yes --pinentry-mode loopback \
                --passphrase "${{ secrets.GPG_PASSPHRASE }}" \
                --detach-sign --armor "$file" || echo "Failed to sign $file"
              
              # Ø¥Ù†Ø´Ø§Ø¡ checksum
              sha256sum "$file" > "${file}.sha256"
            fi
          done
        continue-on-error: true
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}

      - name: "ğŸ“¤ Upload Signed Artifacts"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-linux-signed
          path: |
            unsigned/**/*.deb
            unsigned/**/*.rpm
            unsigned/**/*.tar.gz
            unsigned/**/*.AppImage
            unsigned/**/*.asc
            unsigned/**/*.sha256
          retention-days: 30

  # ===========================================================================
  # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙ‚ÙŠØ¹Ø§Øª
  # ===========================================================================
  verify-signatures:
    name: "âœ… Verify Signatures"
    runs-on: ubuntu-latest
    needs: [sign-windows, sign-macos, sign-linux]
    if: always()
    
    steps:
      - name: "ğŸ“Š Signature Report"
        run: |
          echo "=============================================="
          echo "       ğŸ” Code Signing Report"
          echo "=============================================="
          echo ""
          echo "Platform Results:"
          echo "ğŸªŸ Windows: ${{ needs.sign-windows.result }}"
          echo "ğŸ macOS: ${{ needs.sign-macos.result }}"
          echo "ğŸ§ Linux: ${{ needs.sign-linux.result }}"
          echo ""
          echo "=============================================="
          
          # ØªØ­Ø°ÙŠØ±Ø§Øª
          if [[ "${{ needs.sign-windows.result }}" != "success" ]]; then
            echo "âš ï¸ Windows signing may have issues"
          fi
          if [[ "${{ needs.sign-macos.result }}" != "success" ]]; then
            echo "âš ï¸ macOS signing may have issues"
          fi
          if [[ "${{ needs.sign-linux.result }}" != "success" ]]; then
            echo "âš ï¸ Linux signing may have issues"
          fi
