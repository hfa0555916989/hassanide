# =============================================================================
# HassanIDE - Nightly Builds (Ø¨Ù†Ø§Ø¡ ÙŠÙˆÙ…ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ)
# =============================================================================
# ÙŠØ¹Ù…Ù„ ÙƒÙ„ ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹ UTC
# ÙŠÙ†Ø´Ø¦ Ù†Ø³Ø®Ø© Insiders Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù…Ø³ØªÙ…Ø±
# =============================================================================

name: "ğŸŒ™ Nightly Build"

on:
  schedule:
    # ÙƒÙ„ ÙŠÙˆÙ… Ø§Ù„Ø³Ø§Ø¹Ø© 2 ØµØ¨Ø§Ø­Ø§Ù‹ UTC (5 ØµØ¨Ø§Ø­Ø§Ù‹ Ø¨ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©)
    - cron: '0 2 * * *'
  
  workflow_dispatch:
    inputs:
      platforms:
        description: 'Ø§Ù„Ù…Ù†ØµØ§Øª Ù„Ù„Ø¨Ù†Ø§Ø¡'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - windows
          - macos
          - linux

env:
  NODE_VERSION: '20'
  PRODUCT_NAME: 'HassanIDE-Insiders'

concurrency:
  group: nightly-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ù„ÙŠÙ„ÙŠ
  # ===========================================================================
  prepare-nightly:
    name: "ğŸŒ™ ØªØ­Ø¶ÙŠØ± Nightly"
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      date: ${{ steps.version.outputs.date }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: "ğŸ”¢ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ù‚Ù… Ø¥ØµØ¯Ø§Ø± Nightly"
        id: version
        run: |
          BASE_VERSION=$(node -p "require('./package.json').version")
          DATE=$(date +'%Y%m%d')
          NIGHTLY_VERSION="${BASE_VERSION}-nightly.${DATE}"
          echo "version=$NIGHTLY_VERSION" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ Nightly Version: $NIGHTLY_VERSION"

  # ===========================================================================
  # Ø¨Ù†Ø§Ø¡ Windows Nightly
  # ===========================================================================
  build-windows-nightly:
    name: "ğŸªŸ Windows Nightly"
    runs-on: windows-latest
    needs: prepare-nightly
    if: github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'windows' || github.event.inputs.platforms == ''
    timeout-minutes: 60
    continue-on-error: true
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: "âš™ï¸ Setup build environment"
        run: |
          corepack enable
          npm install -g typescript ts-node @types/node
        continue-on-error: true

      - name: "ğŸ“¦ Install dependencies"
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 20
          max_attempts: 3
          command: npm install --legacy-peer-deps --ignore-scripts
      
      - name: "ğŸ”„ Rebuild"
        run: |
          npm rebuild
          npm run postinstall || true
        continue-on-error: true

      - name: "âš¡ Download Electron"
        run: npm run electron
        continue-on-error: true

      - name: "ğŸ”¨ Compile"
        run: npm run compile
        continue-on-error: true

      - name: "ğŸ“¦ Build Windows x64"
        run: npx gulp vscode-win32-x64-min
        continue-on-error: true

      - name: "ğŸ“ Create ZIP"
        run: |
          $buildPath = "..\VSCode-win32-x64"
          if (Test-Path $buildPath) {
            Compress-Archive -Path $buildPath\* -DestinationPath "HassanIDE-Insiders-win32-x64-${{ needs.prepare-nightly.outputs.version }}.zip" -Force
          }
        shell: pwsh
        continue-on-error: true

      - name: "ğŸ“¤ Upload Nightly Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-nightly-windows
          path: HassanIDE-Insiders-*.zip
          retention-days: 7

  # ===========================================================================
  # Ø¨Ù†Ø§Ø¡ macOS Nightly
  # ===========================================================================
  build-macos-nightly:
    name: "ğŸ macOS Nightly"
    runs-on: macos-14
    needs: prepare-nightly
    if: github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'macos' || github.event.inputs.platforms == ''
    timeout-minutes: 60
    continue-on-error: true
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "âš™ï¸ Setup build environment"
        run: |
          corepack enable
          npm install -g typescript ts-node @types/node
        continue-on-error: true

      - name: "ğŸ“¦ Install dependencies"
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 20
          max_attempts: 3
          command: npm install --legacy-peer-deps --ignore-scripts

      - name: "ğŸ”„ Rebuild"
        run: |
          npm rebuild
          npm run postinstall || true
        continue-on-error: true

      - name: "âš¡ Download Electron"
        run: npm run electron
        continue-on-error: true

      - name: "ğŸ”¨ Compile"
        run: npm run compile
        continue-on-error: true

      - name: "ğŸ“¦ Build macOS ARM64"
        run: npx gulp vscode-darwin-arm64-min
        continue-on-error: true

      - name: "ğŸ“ Create ZIP"
        run: |
          if [ -d "../VSCode-darwin-arm64" ]; then
            cd ..
            zip -r -y "hassanide/HassanIDE-Insiders-darwin-arm64-${{ needs.prepare-nightly.outputs.version }}.zip" "VSCode-darwin-arm64"
          fi
        continue-on-error: true

      - name: "ğŸ“¤ Upload Nightly Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-nightly-macos
          path: HassanIDE-Insiders-*.zip
          retention-days: 7

  # ===========================================================================
  # Ø¨Ù†Ø§Ø¡ Linux Nightly
  # ===========================================================================
  build-linux-nightly:
    name: "ğŸ§ Linux Nightly"
    runs-on: ubuntu-latest
    needs: prepare-nightly
    if: github.event.inputs.platforms == 'all' || github.event.inputs.platforms == 'linux' || github.event.inputs.platforms == ''
    timeout-minutes: 60
    continue-on-error: true
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ”§ Install system dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libx11-dev libxkbfile-dev libsecret-1-dev libkrb5-dev

      - name: "âš™ï¸ Setup build environment"
        run: |
          corepack enable
          npm install -g typescript ts-node @types/node
        continue-on-error: true

      - name: "ğŸ“¦ Install dependencies"
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 20
          max_attempts: 3
          command: npm install --legacy-peer-deps --ignore-scripts

      - name: "ğŸ”„ Rebuild"
        run: |
          npm rebuild
          npm run postinstall || true
        continue-on-error: true

      - name: "âš¡ Download Electron"
        run: npm run electron
        continue-on-error: true

      - name: "ğŸ”¨ Compile"
        run: npm run compile
        continue-on-error: true

      - name: "ğŸ“¦ Build Linux x64"
        run: npx gulp vscode-linux-x64-min
        continue-on-error: true

      - name: "ğŸ“ Create tar.gz"
        run: |
          if [ -d "../VSCode-linux-x64" ]; then
            tar -czvf "HassanIDE-Insiders-linux-x64-${{ needs.prepare-nightly.outputs.version }}.tar.gz" -C .. "VSCode-linux-x64"
          fi
        continue-on-error: true

      - name: "ğŸ“¤ Upload Nightly Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: hassanide-nightly-linux
          path: HassanIDE-Insiders-*.tar.gz
          retention-days: 7

  # ===========================================================================
  # Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Nightly
  # ===========================================================================
  notify-nightly:
    name: "ğŸ“¢ Ø¥Ø´Ø¹Ø§Ø± Nightly"
    runs-on: ubuntu-latest
    needs: 
      - prepare-nightly
      - build-windows-nightly
      - build-macos-nightly
      - build-linux-nightly
    if: always()
    
    steps:
      - name: "ğŸ“Š ØªÙ‚Ø±ÙŠØ± Nightly"
        run: |
          echo "=============================================="
          echo "       ğŸŒ™ Nightly Build Report"
          echo "=============================================="
          echo ""
          echo "ğŸ“¦ Version: ${{ needs.prepare-nightly.outputs.version }}"
          echo "ğŸ“… Date: ${{ needs.prepare-nightly.outputs.date }}"
          echo ""
          echo "Results:"
          echo "ğŸªŸ Windows: ${{ needs.build-windows-nightly.result }}"
          echo "ğŸ macOS: ${{ needs.build-macos-nightly.result }}"
          echo "ğŸ§ Linux: ${{ needs.build-linux-nightly.result }}"

      # Ø¥Ø´Ø¹Ø§Ø± Discord (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      - name: "ğŸ’¬ Discord Notification"
        if: vars.DISCORD_WEBHOOK != ''
        run: |
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "ğŸŒ™ HassanIDE Nightly Build",
                "description": "Version: ${{ needs.prepare-nightly.outputs.version }}",
                "color": 5814783,
                "fields": [
                  {"name": "ğŸªŸ Windows", "value": "${{ needs.build-windows-nightly.result }}", "inline": true},
                  {"name": "ğŸ macOS", "value": "${{ needs.build-macos-nightly.result }}", "inline": true},
                  {"name": "ğŸ§ Linux", "value": "${{ needs.build-linux-nightly.result }}", "inline": true}
                ]
              }]
            }' \
            ${{ vars.DISCORD_WEBHOOK }} || true
        continue-on-error: true
