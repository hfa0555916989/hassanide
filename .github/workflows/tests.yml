# =============================================================================
# HassanIDE - Automated Testing (Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ØªÙ„Ù‚Ø§Ø¦ÙŠØ©)
# =============================================================================
# ÙŠØ¹Ù…Ù„ Ø¹Ù†Ø¯ ÙƒÙ„ Pull Request
# ÙŠØ´ØºÙ„ Unit Tests Ùˆ Integration Tests
# =============================================================================

name: "ğŸ§ª Tests"

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
  workflow_dispatch:

env:
  NODE_VERSION: '20'

concurrency:
  group: tests-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # Unit Tests
  # ===========================================================================
  unit-tests:
    name: "ğŸ§ª Unit Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ”§ Install system dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libx11-dev libxkbfile-dev libsecret-1-dev libkrb5-dev xvfb

      - name: "âš™ï¸ Setup build environment"
        run: |
          corepack enable
          npm install -g typescript ts-node @types/node

      - name: "ğŸ“¦ Install dependencies"
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          command: npm install --legacy-peer-deps --ignore-scripts

      - name: "ğŸ”„ Rebuild"
        run: |
          npm rebuild
          npm run postinstall || true

      - name: "âš¡ Download Electron"
        run: npm run electron

      - name: "ğŸ”¨ Compile"
        run: npm run compile

      - name: "ğŸ§ª Run Unit Tests"
        run: |
          xvfb-run -a npm test || true
        continue-on-error: true

      - name: "ğŸ“Š Upload Test Results"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-unit
          path: |
            test-results/
            coverage/
          retention-days: 7

  # ===========================================================================
  # Integration Tests
  # ===========================================================================
  integration-tests:
    name: "ğŸ”— Integration Tests"
    runs-on: ubuntu-latest
    timeout-minutes: 45
    needs: unit-tests
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ”§ Install system dependencies"
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libx11-dev libxkbfile-dev libsecret-1-dev libkrb5-dev xvfb libnss3 libatk-bridge2.0-0 libgtk-3-0 libgbm1

      - name: "âš™ï¸ Setup build environment"
        run: |
          corepack enable
          npm install -g typescript ts-node @types/node

      - name: "ğŸ“¦ Install dependencies"
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          command: npm install --legacy-peer-deps --ignore-scripts

      - name: "ğŸ”„ Rebuild"
        run: |
          npm rebuild
          npm run postinstall || true

      - name: "âš¡ Download Electron"
        run: npm run electron

      - name: "ğŸ”¨ Compile"
        run: npm run compile

      - name: "ğŸ”— Run Integration Tests"
        run: |
          xvfb-run -a npm run test-integration || true
        continue-on-error: true

      - name: "ğŸ“Š Upload Test Results"
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-integration
          path: |
            test-results/
            .build/logs/
          retention-days: 7

  # ===========================================================================
  # Smoke Tests (Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©)
  # ===========================================================================
  smoke-tests:
    name: "ğŸ’¨ Smoke Tests"
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-14]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 30
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "ğŸ”§ Install Linux dependencies"
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libx11-dev libxkbfile-dev libsecret-1-dev libkrb5-dev xvfb

      - name: "âš™ï¸ Setup build environment"
        run: |
          corepack enable
          npm install -g typescript ts-node @types/node
        continue-on-error: true

      - name: "ğŸ“¦ Install dependencies"
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 15
          max_attempts: 3
          command: npm install --legacy-peer-deps --ignore-scripts

      - name: "ğŸ”„ Rebuild"
        run: |
          npm rebuild
          npm run postinstall || true
        continue-on-error: true

      - name: "âš¡ Download Electron"
        run: npm run electron
        continue-on-error: true

      - name: "ğŸ”¨ Compile"
        run: npm run compile
        continue-on-error: true

      - name: "ğŸ’¨ Smoke Test - Linux"
        if: runner.os == 'Linux'
        run: |
          xvfb-run -a node build/lib/preLaunch.js || true
        continue-on-error: true

      - name: "ğŸ’¨ Smoke Test - Windows/macOS"
        if: runner.os != 'Linux'
        run: |
          node build/lib/preLaunch.js || true
        continue-on-error: true

  # ===========================================================================
  # Lint & Type Check
  # ===========================================================================
  lint:
    name: "âœ¨ Lint & Type Check"
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: "âš™ï¸ Setup"
        run: |
          corepack enable
          npm install -g typescript

      - name: "ğŸ“¦ Install dependencies"
        uses: nick-fields/retry@v2
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: npm install --legacy-peer-deps --ignore-scripts

      - name: "âœ¨ ESLint"
        run: npm run eslint || true
        continue-on-error: true

      - name: "ğŸ“ Type Check"
        run: npx tsc --noEmit || true
        continue-on-error: true

  # ===========================================================================
  # ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù†ØªØ§Ø¦Ø¬
  # ===========================================================================
  test-summary:
    name: "ğŸ“Š Test Summary"
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests, smoke-tests, lint]
    if: always()
    
    steps:
      - name: "ğŸ“Š Summary"
        run: |
          echo "=============================================="
          echo "       ğŸ§ª Test Results Summary"
          echo "=============================================="
          echo ""
          echo "ğŸ§ª Unit Tests: ${{ needs.unit-tests.result }}"
          echo "ğŸ”— Integration: ${{ needs.integration-tests.result }}"
          echo "ğŸ’¨ Smoke Tests: ${{ needs.smoke-tests.result }}"
          echo "âœ¨ Lint: ${{ needs.lint.result }}"
          echo ""
          
          # Check if any critical test failed
          if [[ "${{ needs.unit-tests.result }}" == "failure" ]]; then
            echo "âš ï¸ Unit tests failed!"
          fi
          if [[ "${{ needs.lint.result }}" == "failure" ]]; then
            echo "âš ï¸ Lint check failed!"
          fi
